import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { Swiper, SwiperSlide } from 'swiper/react';
import type { Swiper as SwiperType } from 'swiper';
import 'swiper/css';
import { 
  Home, 
  Sprout, 
  BookOpen, 
  Moon, 
  Sun, 
  MapPin, 
  Play, 
  Book, 
  Volume2,
  Pause,
  ChevronLeft,
  Search,
  GraduationCap,
  Settings,
  Share2,
  HelpCircle,
  User,
  Info,
  Type as TypeIcon,
  Check,
  Plus,
  RotateCcw,
  List,
  Sunrise,
  Sunset,
  MoonStar,
  Bed,
  CloudSun,
  Star,
  Download,
  Cloud,
  Mic,
  Trophy,
  Users,
  Trash2,
  Maximize
} from 'lucide-react';

// --- Types ---
type Section = 'home' | 'farm' | 'knowledge' | 'quran-reader' | 'settings' | 'misbaha' | 'adhkar' | 'ahl-allah';

interface Surah {
  number: number;
  name: string;
  englishName: string;
  numberOfAyahs: number;
  revelationType: string;
}

interface Ayah {
  number: number;
  text: string;
  numberInSurah: number;
  page: number;
}

type BookmarkType = 'fast' | 'reflection' | 'memorization' | 'general';

interface Bookmark {
  surahName: string;
  surahNumber: number;
  ayahNumber: number;
  type: BookmarkType;
}

interface PrayerTimes {
  Fajr: string;
  Dhuhr: string;
  Asr: string;
  Maghrib: string;
  Isha: string;
}

interface Verse {
  text: string;
  surah: string;
  number: number;
}

interface Reciter {
  id: string;
  name: string;
  server: string;
}

interface Tafsir {
  id: string;
  name: string;
}

// --- Background Decorations ---
function BackgroundDecorations({ isDarkMode }: { isDarkMode: boolean }) {
  return (
    <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
      <AnimatePresence mode="wait">
        {!isDarkMode ? (
          <motion.div
            key="day-decor"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0"
          >
            {/* Sun */}
            <motion.div 
              animate={{ rotate: 360 }}
              transition={{ duration: 50, repeat: Infinity, ease: "linear" }}
              className="absolute -top-20 -right-20 w-64 h-64 bg-yellow-200/20 rounded-full blur-3xl"
            />
            <div className="absolute top-10 right-10 text-yellow-400/30">
              <Sun size={120} strokeWidth={1} />
            </div>
            
            {/* Clouds */}
            <motion.div 
              animate={{ x: [0, 50, 0] }}
              transition={{ duration: 20, repeat: Infinity, ease: "easeInOut" }}
              className="absolute top-40 left-[10%] text-white/40"
            >
              <CloudSun size={80} strokeWidth={1} />
            </motion.div>
            <motion.div 
              animate={{ x: [0, -30, 0] }}
              transition={{ duration: 15, repeat: Infinity, ease: "easeInOut" }}
              className="absolute top-80 right-[15%] text-white/30"
            >
              <Cloud size={60} strokeWidth={1} />
            </motion.div>
          </motion.div>
        ) : (
          <motion.div
            key="night-decor"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0"
          >
            {/* Moon */}
            <div className="absolute top-10 right-10 text-slate-400/20">
              <MoonStar size={100} strokeWidth={1} />
            </div>
            
            {/* Stars */}
            {[...Array(15)].map((_, i) => (
              <motion.div
                key={i}
                initial={{ opacity: 0.2 }}
                animate={{ opacity: [0.2, 0.8, 0.2] }}
                transition={{ duration: 2 + Math.random() * 3, repeat: Infinity }}
                className="absolute text-white/20"
                style={{
                  top: `${Math.random() * 100}%`,
                  left: `${Math.random() * 100}%`,
                }}
              >
                <Star size={10 + Math.random() * 10} fill="currentColor" />
              </motion.div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

// --- Main App Component ---
const knowledgeData: Record<string, Record<string, string>> = {
  'العقيدة': {
    'إثبات علو الله واستوائه على عرشه': 'هذا الفصل مخصص لبيان معتقد أهل السنة والجماعة في صفة العلو والاستواء.\n\n١. تعريف العلو: هو انفراد الله تعالى بجهة العلو المطلق فوق جميع خلقه، فهو فوق العرش، والعرش فوق السماوات.\n\n٢. الأدلة من القرآن:\n- {الرَّحْمَنُ عَلَى الْعَرْشِ اسْتَوَى} [طه: ٥].\n- {أَأَمِنتُم مَّن فِي السَّمَاءِ أَن يَخْسِفَ بِكُمُ الْأَرْضَ} [الملك: ١٦].\n- {يَخَافُونَ رَبَّهُم مِّن فَوْقِهِمْ} [النحل: ٥٠].\n\n٣. الأدلة من السنة:\n- حديث الجارية: سألها النبي ﷺ: "أين الله؟" قالت: في السماء. قال: "من أنا؟" قالت: أنت رسول الله. قال: "أعتقها فإنها مؤمنة".\n- حديث المعراج: عروجه ﷺ إلى ربه فوق السماوات السبع.\n\n٤. أقوال السلف الصالح:\n- قول الإمام مالك: "الاستواء معلوم، والكيف مجهول، والإيمان به واجب، والسؤال عنه بدعة".\n- إجماع الصحابة والتابعين على أن الله فوق عرشه بائن من خلقه.\n\n٥. الرد على الشبهات:\n- الاستواء ليس بمعنى الاستيلاء، لأن الاستيلاء يكون بعد مغالبة، والله لا غالب له.\n- العلو لا يقتضي التحيز أو الجسمية كما يتوهم المعطلة، بل هو علو يليق بجلاله وعظمته.',
    'توحيد الألوهية (التفصيل العميق)': 'توحيد الألوهية هو إفراد الله سبحانه وتعالى بالعبادة، وهو المعنى الحقيقي لشهادة "لا إله إلا الله". \n\nلماذا هو الأهم؟\nلأنه الغاية التي من أجلها خلق الله الجن والإنس، كما قال تعالى: {وَمَا خَلَقْتُ الْجِنَّ وَالْإِنسَ إِلَّا لِيَعْبُدُونِ}. وهو الذي وقع فيه النزاع بين الرسل وأممهم، فالمشركون كانوا يقرون بأن الله هو الخالق (الربوبية) لكنهم كانوا يعبدون معه غيره (الألوهية).\n\nأركان العبادة:\n1. المحبة: أن تعبد الله حباً فيه.\n2. الخوف: أن تخاف من وعيده وعقابه.\n3. الرجاء: أن ترجو ثوابه وجنته.\n\nأنواع العبادة الظاهرة والباطنة:\n- الصلاة، الزكاة، الحج (ظاهرة).\n- التوكل، الإنابة، الخشية، الرغبة (باطنة).\n\nمن صرف شيئاً من هذه العبادات لغير الله (كالدعاء لغير الله أو الذبح لغير الله) فقد وقع في الشرك الأكبر المخرج من الملة.',
    'توحيد الربوبية (شرح موسع)': 'هو الإقرار الجازم بأن الله تعالى هو الرب الخالق المالك المدبر لكل شيء. \n\nخصائص الربوبية:\n1. الخلق: فلا خالق إلا الله.\n2. الملك: فلا مالك حقيقي لكل شيء إلا الله.\n3. التدبير: فلا مدبر لأمر الكون إلا الله.\n\nعلاقة الربوبية بالألوهية:\nتوحيد الربوبية يستلزم توحيد الألوهية، فمن اعترف بأن الله هو الخالق الرازق، وجب عليه عقلاً وشرعاً أن يعبده وحده ولا يشرك به شيئاً. قال تعالى: {يَا أَيُّهَا النَّاسُ اعْبُدُوا رَبَّكُمُ الَّذِي خَلَقَكُمْ وَالَّذِينَ مِن قَبْلِكُمْ لَعَلَّكُمْ تَتَّقُونَ}.',
    'توحيد الأسماء والصفات (منهج السلف)': 'هو إثبات ما أثبته الله لنفسه في كتابه أو أثبته له رسوله ﷺ في سنته، من غير تحريف ولا تعطيل، ومن غير تكييف ولا تمثيل.\n\nالقواعد الذهبية:\n- ليس كمثله شيء: نفي المماثلة للمخلوقين.\n- وهو السميع البصير: إثبات الصفات كما تليق بجلاله.\n- نمرها كما جاءت: لا نسأل عن الكيفية (كيف استوى؟ كيف ينزل؟) لأن عقلنا قاصر عن إدراك كنه ذات الله وصفاته.\n\nأهمية هذا العلم:\nأنه يورث العبد تعظيماً لله ومحبة له، فكلما عرف العبد ربه بصفات كماله، زاد إيمانه وخضوعه.',
    'أركان الإيمان الستة (تفصيل)': '1. الإيمان بالله: وجوده، ربوبيته، ألوهيته، أسماؤه وصفاته.\n2. الإيمان بالملائكة: عالم غيبي خلقوا من نور، لا يعصون الله ما أمرهم. نؤمن بأسماء من سمي منهم كجبريل وميكائيل وإسرافيل ومالك وخازن الجنة.\n3. الإيمان بالكتب: التوراة (موسى)، الإنجيل (عيسى)، الزبور (داود)، الصحف (إبراهيم وموسى)، والقرآن الكريم (محمد ﷺ) وهو المهيمن والناسخ لها.\n4. الإيمان بالرسل: نؤمن بجميع الأنبياء والرسل، وأنهم بلغوا الرسالة وأدوا الأمانة. أولهم نوح وآخرهم محمد ﷺ.\n5. الإيمان باليوم الآخر: كل ما يكون بعد الموت من فتنة القبر وعذابه ونعيمه، والبعث والحشر والحساب والميزان والصراط والجنة والنار.\n6. الإيمان بالقدر: الإيمان بعلم الله القديم، وكتابته للمقادير، ومشيئته النافذة، وخلقه لكل شيء. (خيره وشره من الله خلقاً وتقديراً).',
    'الولاء والبراء (أصل عظيم)': 'الولاء هو محبة الله ورسوله والمؤمنين ونصرتهم. والبراء هو بغض الكفر والشرك وأهله ومعاداتهم في الله.\n\nمراتب الناس في الولاء والبراء:\n1. من يحب حباً خالصاً: وهم الأنبياء والصديقون والمؤمنون الخلص.\n2. من يحب من وجه ويبغض من وجه: وهم عصاة المؤمنين، يحبون لإيمانهم ويبغضون لمعصيتهم.\n3. من يبغض بغضاً خالصاً: وهم الكفار والمشركون والمنافقون نفاقاً أكبر.',
    'نواقض الإسلام العشرة': '١. الشرك في عبادة الله.\n٢. من جعل بينه وبين الله وسائط يدعوهم ويسألهم الشفاعة.\n٣. من لم يكفر المشركين أو شك في كفرهم.\n٤. من اعتقد أن هدي غير النبي ﷺ أكمل من هديه.\n٥. من أبغض شيئاً مما جاء به الرسول ﷺ.\n٦. من استهزأ بشيء من دين الرسول ﷺ.\n٧. السحر.\n٨. مظاهرة المشركين ومعاونتهم على المسلمين.\n٩. من اعتقد أن بعض الناس يسعه الخروج عن شريعة محمد ﷺ.\n١٠. الإعراض عن دين الله، لا يتعلمه ولا يعمل به.',
  },
  'الفقه': {
    'فقه الصلاة (شرح الأركان)': 'الصلاة هي عماد الدين، وأول ما يحاسب عليه العبد يوم القيامة.\n\nأركان الصلاة (14 ركناً):\n1. القيام في الفرض للقادر.\n2. تكبيرة الإحرام.\n3. قراءة الفاتحة.\n4. الركوع.\n5. الرفع من الركوع.\n6. الاعتدال قائماً.\n7. السجود على الأعضاء السبعة.\n8. الرفع من السجود.\n9. الجلسة بين السجدتين.\n10. الطمأنينة في جميع الأركان.\n11. التشهد الأخير.\n12. الجلوس للتشهد الأخير.\n13. الصلاة على النبي ﷺ.\n14. التسليم.\n\nمن ترك ركناً عمداً بطلت صلاته، ومن تركه سهواً وجب عليه الإتيان به وسجود السهو.',
    'فقه الزكاة (أحكام المال)': 'الزكاة حق واجب في مال مخصوص لطائفة مخصوصة.\n\nشروط وجوبها:\n- الإسلام، الحرية، ملك النصاب، ومرور الحول (سنة).\n\nالأصناف الثمانية (مصارف الزكاة):\n1. الفقراء.\n2. المساكين.\n3. العاملون عليها.\n4. المؤلفة قلوبهم.\n5. في الرقاب (عتق العبيد).\n6. الغارمون (أصحاب الديون).\n7. في سبيل الله (الجهاد والدعوة).\n8. ابن السبيل (المسافر المنقطع).\n\nلا يجوز صرف الزكاة لغير هؤلاء، ولا تجوز للوالدين أو الأبناء لأن نفقتهم واجبة.',
    'فقه الصيام (أسرار وأحكام)': 'الصيام هو الإمساك عن المفطرات من طلوع الفجر إلى غروب الشمس بنية.\n\nمبطلات الصيام:\n- الأكل والشرب عمداً.\n- الجماع.\n- التقيؤ عمداً.\n- خروج دم الحيض والنفاس.\n- الحجامة (في أصح قولي العلماء).\n\nمن أفطر لعذر (مرض أو سفر) وجب عليه القضاء. ومن أفطر بجماع وجب عليه القضاء والكفارة المغلظة (عتق رقبة، فإن لم يجد فصيام شهرين متتابعين، فإن لم يجد فإطعام ستين مسكيناً).',
    'فقه الحج والعمرة (المناسك)': 'الحج ركن من أركان الإسلام لمن استطاع إليه سبيلاً.\n\nأركان الحج:\n1. الإحرام.\n2. الوقوف بعرفة.\n3. طواف الإفاضة.\n4. السعي بين الصفا والمروة.\n\nواجبات الحج:\n- الإحرام من الميقات، المبيت بمزدلفة، المبيت بمنى، رمي الجمار، الحلق أو التقصير، وطواف الوداع.\n\nمن ترك ركناً لم يتم حجه إلا به، ومن ترك واجباً جبره بدم (ذبيحة).',
    'أحكام البيوع والمعاملات': 'الأصل في البيوع الحل إلا ما ورد تحريمه. المحرمات في البيوع ترجع إلى ثلاثة أصول: الربا، الغرر (الجهالة)، والظلم.\nأنواع الربا: ربا الفضل (زيادة في أحد العوضين المتجانسين) وربا النسيئة (تأخير في قبض أحد العوضين).',
    'أحكام النكاح والأسرة': 'النكاح سنة الأنبياء، وشروطه: تعيين الزوجين، رضا الزوجين، الولي، والشهود. والمحرمات من النساء نوعان: محرمات مؤبدة (بالنسب أو الرضاع أو المصاهرة) ومحرمات مؤقتة.',
    'أحكام الجنائز': 'حق المسلم على المسلم خمس، منها اتباع الجنائز. غسل الميت وتكفينه والصلاة عليه ودفنه فرض كفاية. صفة صلاة الجنازة: أربع تكبيرات، بعد الأولى الفاتحة، وبعد الثانية الصلاة الإبراهيمية، وبعد الثالثة الدعاء للميت، وبعد الرابعة دعاء عام ثم تسليمة واحدة.',
    'أحكام الأضحية والعقيقة': 'الأضحية سنة مؤكدة تذبح في أيام عيد الأضحى تقرباً لله. شروطها: أن تكون من بهيمة الأنعام، أن تبلغ السن المعتبرة، أن تكون سليمة من العيوب، وأن تذبح في الوقت المحدد. العقيقة: هي الذبيحة عن المولود، شاتان عن الغلام وشاة عن الجارية.',
    'أحكام الطهارة والنجاسات': 'الطهارة مفتاح الصلاة. المياه أنواع: طهور (يطهر نفسه وغيره)، وطاهر (في نفسه غير مطهر لغيره)، ونجس. النجاسات يجب إزالتها من البدن والثوب والمكان.',
    'أحكام الأيمان والنذور': 'اليمين هو الحلف بالله أو بصفة من صفاته. كفارة اليمين: إطعام عشرة مساكين أو كسوتهم أو تحرير رقبة، فمن لم يجد فصيام ثلاثة أيام. النذر: هو إلزام المكلف نفسه بعبادة لم تكن واجبة عليه، والوفاء بنذر الطاعة واجب.',
    'فقه المعاملات المالية المعاصرة': 'تشمل أحكام البطاقات الائتمانية، التورق، المرابحة للآمر بالشراء، والتأمين. القاعدة العامة: كل معاملة خلت من الربا والغرر والظلم فهي حلال. ويجب الحذر من العقود التي تشتمل على فوائد ربوية خفية.',
  },
  'الحديث': {
    'أهمية السنة النبوية': 'السنة هي الوحي الثاني، وهي شارحة للقرآن ومبينة لمجمله. قال ﷺ: "ألا إني أوتيت القرآن ومثله معه". وقال الإمام البربهاري: "الإسلام هو السنة، والسنة هي الإسلام". ولا يستقيم إيمان عبد حتى يؤمن بالسنة ويعمل بها ويقدمها على قول كل أحد.',
    'الأربعين النووية ١: الأعمال بالنيات': 'عن أمير المؤمنين أبي حفص عمر بن الخطاب رضي الله عنه قال: سمعت رسول الله ﷺ يقول: "إنما الأعمال بالنيات، وإنما لكل امرئ ما نوى..."\n\nالشرح: النية هي أساس قبول العمل، فمن كان قصده الله ورسوله قبل عمله، ومن كان قصده الدنيا أو امرأة ينكحها فليس له إلا ما نوى.',
    'الأربعين النووية ٢: حديث جبريل': 'عن عمر رضي الله عنه أيضاً قال: بينما نحن جلوس عند رسول الله ﷺ ذات يوم إذ طلع علينا رجل شديد بياض الثياب شديد سواد الشعر...\n\nالشرح: الحديث يبين مراتب الدين الثلاث: الإسلام (الأعمال الظاهرة)، الإيمان (الاعتقادات الباطنة)، والإحسان (مراقبة الله).',
    'الأربعين النووية ٣: أركان الإسلام': 'عن أبي عبد الرحمن عبد الله بن عمر بن الخطاب رضي الله عنهما قال: سمعت رسول الله ﷺ يقول: "بني الإسلام على خمس..."\n\nالشرح: الإسلام بناء عظيم يقوم على خمسة أعمدة أساسية: الشهادتان، الصلاة، الزكاة، الحج، وصوم رمضان.',
    'الأربعين النووية ٤: مراحل الخلق': 'عن أبي عبد الرحمن عبد الله بن مسعود رضي الله عنه قال: حدثنا رسول الله ﷺ وهو الصادق المصدوق: "إن أحدكم يجمع خلقه في بطن أمه أربعين يوماً نطفة..."\n\nالشرح: يبين أطوار الجنين وكتابة القدر (الرزق، الأجل، العمل، والشقاوة أو السعادة).',
    'الأربعين النووية ٥: النهي عن البدع': 'عن أم المؤمنين أم عبد الله عائشة رضي الله عنها قالت: قال رسول الله ﷺ: "من أحدث في أمرنا هذا ما ليس منه فهو رد".\n\nالشرح: الدين كامل لا يحتاج لزيادة، وكل عمل تعبدي لم يشرعه الله ورسوله فهو باطل ومردود على صاحبه.',
    'الأربعين النووية ٦: الورع': 'عن أبي عبد الله النعمان بن بشير رضي الله عنهما قال: سمعت رسول الله ﷺ يقول: "إن الحلال بين وإن الحرام بين وبينهما أمور مشتبهات..."\n\nالشرح: المؤمن يبتعد عن الشبهات حماية لدينه وعرضه، وصلاح الجسد بصلاح القلب.',
    'الأربعين النووية ٧: النصيحة': 'عن أبي رقية تميم بن أوس الداري رضي الله عنه أن النبي ﷺ قال: "الدين النصيحة". قلنا: لمن؟ قال: "لله ولكتابه ولرسوله ولأئمة المسلمين وعامتهم".\n\nالشرح: الدين يقوم على النصح والإخلاص في التعامل مع الخالق والخلق.',
    'الأربعين النووية ٨: حرمة المسلم': 'عن ابن عمر رضي الله عنهما أن رسول الله ﷺ قال: "أمرت أن أقاتل الناس حتى يشهدوا أن لا إله إلا الله وأن محمداً رسول الله..."\n\nالشرح: الإسلام يحمي دماء وأموال من دخل فيه، والحساب على الله في السرائر.',
    'الأربعين النووية ٩: الاستطاعة': 'عن أبي هريرة عبد الرحمن بن صخر رضي الله عنه قال: سمعت رسول الله ﷺ يقول: "ما نهيتكم عنه فاجتنبوه، وما أمرتكم به فأتوا منه ما استطعتم..."\n\nالشرح: النهي يجب تركه مطلقاً، أما الأمر فمقيد بالقدرة والاستطاعة.',
    'الأربعين النووية ١٠: الطيب من الكسب': 'عن أبي هريرة رضي الله عنه قال: قال رسول الله ﷺ: "إن الله تعالى طيب لا يقبل إلا طيباً..."\n\nالشرح: أكل الحلال شرط لقبول الدعاء، والمال الحرام يمنع استجابة العبادات.',
    'الأربعين النووية ١١: دع ما يريبك': 'عن أبي محمد الحسن بن علي رضي الله عنهما قال: حفظت من رسول الله ﷺ: "دع ما يريبك إلى ما لا يريبك".\n\nالشرح: الورع هو ترك الشبهات والاطمئنان للحلال المحض.',
    'الأربعين النووية ١٢: من حسن إسلام المرء': 'عن أبي هريرة رضي الله عنه قال: قال رسول الله ﷺ: "من حسن إسلام المرء تركه ما لا يعنيه".\n\nالشرح: الاشتغال بما ينفع في الدين والدنيا وترك الفضول.',
    'الأربعين النووية ١٣: حب الخير للغير': 'عن أبي حمزة أنس بن مالك رضي الله عنه قال: قال رسول الله ﷺ: "لا يؤمن أحدكم حتى يحب لأخيه ما يحب لنفسه".\n\nالشرح: كمال الإيمان يقتضي سلامة الصدر ومحبة الخير للمسلمين.',
    'الأربعين النووية ١٤: حرمة دم المسلم': 'عن ابن مسعود رضي الله عنه قال: قال رسول الله ﷺ: "لا يحل دم امرئ مسلم إلا بإحدى ثلاث: الثيب الزاني، والنفس بالنفس، والتارك لدينه المفارق للجماعة".',
    'الأربعين النووية ١٥: إكرام الضيف والجار': 'عن أبي هريرة رضي الله عنه أن رسول الله ﷺ قال: "من كان يؤمن بالله واليوم الآخر فليقل خيراً أو ليصمت..."',
    'الأربعين النووية ١٦: النهي عن الغضب': 'عن أبي هريرة رضي الله عنه أن رجلاً قال للنبي ﷺ: أوصني. قال: "لا تغضب". فردد مراراً، قال: "لا تغضب".',
    'الأربعين النووية ١٧: الإحسان في كل شيء': 'عن أبي يعلى شداد بن أوس رضي الله عنه قال: قال رسول الله ﷺ: "إن الله كتب الإحسان على كل شيء، فإذا قتلتم فأحسنوا القتلة..."',
    'الأربعين النووية ١٨: التقوى وحسن الخلق': 'عن أبي ذر ومعاذ بن جبل رضي الله عنهما أن رسول الله ﷺ قال: "اتق الله حيثما كنت، وأتبع السيئة الحسنة تمحها، وخالق الناس بخلق حسن".',
    'الأربعين النووية ١٩: الاستعانة بالله': 'عن ابن عباس رضي الله عنهما قال: كنت خلف النبي ﷺ يوماً فقال: "يا غلام إني أعلمك كلمات: احفظ الله يحفظك..."',
    'الأربعين النووية ٢٠: الحياء': 'عن ابن مسعود رضي الله عنه قال: قال رسول الله ﷺ: "إن مما أدرك الناس من كلام النبوة الأولى: إذا لم تستح فاصنع ما شئت".',
    'أقسام الحديث من حيث القبول': '1. الصحيح: ما اتصل سنده بنقل العدل الضابط عن مثله إلى منتهاه من غير شذوذ ولا علة.\n2. الحسن: ما اتصل سنده بنقل العدل الذي خف ضبطه.\n3. الضعيف: ما لم يجتمع فيه صفات الصحيح ولا الحسن.\n4. الموضوع: المكذوب على رسول الله ﷺ، وهو شر الأقسام.',
    'الكتب الستة الأصول': 'هي الكتب التي اعتمدها العلماء كأصول للحديث النبوي:\n1. صحيح البخاري (أصح الكتب بعد القرآن).\n2. صحيح مسلم.\n3. سنن أبي داود.\n4. سنن الترمذي.\n5. سنن النسائي.\n6. سنن ابن ماجه.',
    'علوم الحديث (المصطلح)': 'علم يعرف به حال الراوي والمروي من حيث القبول والرد. يشمل دراسة الجرح والتعديل، ومعرفة علل الحديث، ودراية الأسانيد والمتون. يهدف لحماية السنة من الدخيل والخطأ.',
    'الأربعون النووية': 'مجموعة من الأحاديث النبوية التي جمعها الإمام النووي، وتعتبر من جوامع الكلم، حيث يشتمل كل حديث منها على قاعدة عظيمة من قواعد الدين.',
    'منزلة الصحابة في الرواية': 'الصحابة كلهم عدول بتعديل الله لهم في القرآن، فلا نبحث عن عدالتهم، بل نبحث عمن روى عنهم. حبهم دين وإيمان، وبغضهم كفر وطغيان.',
    'حجية السنة': 'السنة حجة بنفسها في الأحكام والعقائد، والواجب على المسلم التسليم لها كما يسلم للقرآن. قال تعالى: {وَمَا آتَاكُمُ الرَّسُولُ فَخُذُوهُ وَمَا نَهَاكُمْ عَنْهُ فَانتَهُوا}.',
  },
  'السيرة': {
    'نسب النبي ﷺ ونشأته': 'هو محمد بن عبد الله بن عبد المطلب بن هاشم بن عبد مناف. ولد في مكة عام الفيل (571م). مات أبوه وهو في بطن أمه، وماتت أمه وهو ابن ست سنين، فكفله جده عبد المطلب، ثم عمه أبو طالب. لقب بالصادق الأمين قبل البعثة.',
    'نزول الوحي والبعثة': 'نزل عليه الوحي وهو في سن الأربعين في غار حراء. بدأت الدعوة سراً لمدة ثلاث سنوات، ثم جهر بها. واجه النبي ﷺ وأصحابه أذى شديداً من قريش، مما أدى للهجرة إلى الحبشة ثم الهجرة الكبرى إلى المدينة.',
    'الهجرة النبوية (نقطة التحول)': 'هاجر النبي ﷺ مع أبي بكر الصديق إلى يثرب (المدينة المنورة). استقبله الأنصار بحفاوة، وبنى المسجد النبوي، وآخى بين المهاجرين والأنصار، ووضع وثيقة المدينة لتنظيم العلاقة بين سكانها.',
    'العهد المكي والمدني': 'السيرة النبوية هي التطبيق العملي للإسلام.\nالعهد المكي (13 سنة): ركز على غرس التوحيد والصبر على الأذى. من أحداثه: نزول الوحي، الجهر بالدعوة، الهجرة إلى الحبشة، الإسراء والمعراج.\nالعهد المدني (10 سنوات): بناء الدولة وتشريع الأحكام. من أحداثه: المؤاخاة، الغزوات (بدر، أحد، الخندق)، صلح الحديبية، فتح مكة، حجة الوداع، ووفاة النبي ﷺ.',
    'الشمائل المحمدية': 'هي صفات النبي ﷺ الخلقية والخُلقية. كان ﷺ أجود الناس، وأشجع الناس، وأحسن الناس وجهاً، وأطيبهم ريحاً. كان خلقه القرآن، متواضعاً، رحيماً، لا يغضب لنفسه، بل يغضب إذا انتهكت حرمات الله.',
    'غزوات الرسول ﷺ': 'بلغت غزواته ﷺ 27 غزوة، قاتل في 9 منها بنفسه. ومن أهمها: بدر (الفرقان)، أحد (الابتلاء)، الخندق (الأحزاب)، خيبر (فتح حصون اليهود)، حنين، وتبوك (العسرة). وكان الهدف منها إعلاء كلمة الله وحماية الدعوة.',
    'حقوق النبي ﷺ على أمته': '1. الإيمان به وبما جاء به.\n2. طاعته واتباع سنته.\n3. محبته أكثر من النفس والولد والناس أجمعين.\n4. تعظيمه وتوقيره ونصرته.\n5. الصلاة والسلام عليه ﷺ.',
    'آل بيت النبي ﷺ': 'هم أزواجه وذريته وكل مسلم من بني هاشم وبني المطلب. نحبهم ونتولاهم ونعرف لهم فضلهم وقرابتهم من رسول الله ﷺ، ونبرأ من طريقة الغلاة والجفاة فيهم.',
    'خلفاء النبي ﷺ (الراشدون)': 'أبو بكر الصديق، عمر بن الخطاب، عثمان بن عفان، علي بن أبي طالب. هم الذين خلفوا النبي ﷺ في قيادة الأمة، وساروا على نهجه، ومدتهم ثلاثون سنة.',
  },
  'علوم القرآن': {
    'نزول القرآن': 'نزل القرآن منجماً (مفرقاً) على النبي ﷺ في ثلاث وعشرين سنة، حسب الوقائع والأحداث، تثبيتاً لقلب النبي ﷺ وتيسيراً لحفظه وفهمه.',
    'المكي والمدني': 'المكي: ما نزل قبل الهجرة، ويركز على العقيدة والتوحيد. المدني: ما نزل بعد الهجرة، ويركز على التشريعات والأحكام وبناء المجتمع.',
    'أسباب النزول': 'علم يبحث في الظروف والأحداث التي نزلت فيها الآيات، مما يساعد على فهم المعنى الصحيح وإزالة الإشكال.',
    'الإعجاز القرآني': 'القرآن معجزة الله الخالدة، تحدى الله به العرب أن يأتوا بمثله. يشمل الإعجاز البياني، التشريعي، العلمي، والغيبي.',
    'القراءات السبع': 'هي وجوه من الأداء ثابتة عن النبي ﷺ، نقلها القراء بالتواتر، وهي تيسير من الله للأمة في قراءة كتابه.',
    'آداب تلاوة القرآن': 'الإخلاص، الطهارة، الاستعاذة والبسملة، التدبر، العمل بما فيه، وتحسين الصوت بالقرآن.',
  },
  'الأخلاق والآداب': {
    'أهمية الخلق في الإسلام': 'قال ﷺ: "إنما بعثت لأتمم مكارم الأخلاق". الخلق الحسن هو أثقل شيء في ميزان المؤمن يوم القيامة، وهو دليل كمال الإيمان.',
    'خلق الصدق': 'الصدق منجاة، وهو صفة الأنبياء والمؤمنين. قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا اتَّقُوا اللَّهَ وَكُونُوا مَعَ الصَّادِقِينَ}.',
    'خلق الأمانة': 'الأمانة تشمل حفظ الحقوق، وأداء الواجبات، وكتمان الأسرار. وهي ضد الخيانة، ومن علامات الإيمان.',
    'خلق الحياء': 'الحياء من الإيمان، وهو يمنع العبد من فعل القبيح والتقصير في حق الله وحق الخلق. قال ﷺ: "الحياء لا يأتي إلا بخير".',
    'خلق الصبر': 'الصبر ضياء، وهو ثلاثة أنواع: صبر على طاعة الله، صبر عن معصية الله، وصبر على أقدار الله المؤلمة.',
    'آداب الاستئذان': 'من الآداب الاجتماعية التي تحفظ الخصوصية، ويكون ثلاثاً، فإن أذن لك وإلا فارجع، مع عدم الوقوف أمام الباب مباشرة.',
  },
  'اللغة العربية': {
    'علوم اللغة العربية': 'اللغة العربية هي وعاء الوحي، وعلومها اثنا عشر علماً، أهمها:\n1. النحو: لمعرفة أحكام أواخر الكلمات.\n2. الصرف: لمعرفة بنية الكلمة وتصريفها.\n3. البلاغة: (المعاني، البيان، البديع) لمعرفة أسرار الفصاحة.\n4. اللغة والمتن: لمعرفة معاني المفردات.\nتعلمها فرض كفاية، وقد يكون فرض عين فيما يتوقف عليه فهم القرآن والسنة.',
    'أهمية اللغة في فهم الدين': 'قال عمر بن الخطاب رضي الله عنه: "تعلموا العربية فإنها من دينكم". فلا يمكن فهم القرآن والسنة فهماً صحيحاً إلا بمعرفة لسان العرب، وقواعد لغتهم، وأساليب بيانهم. وكثير من البدع نشأت بسبب الجهل باللغة العربية.',
    'قواعد النحو الأساسية (المرفوعات)': 'المرفوعات من الأسماء سبعة: المبتدأ، الخبر، الفاعل، نائب الفاعل، اسم كان، خبر إن، والتابع للمرفوع (النعت، العطف، التوكيد، البدل).',
    'قواعد الصرف (الميزان الصرفي)': 'الميزان الصرفي هو مقياس وضعه علماء العرب لمعرفة أحوال بنية الكلمة، وجعلوه على وزن (فعل). الفاء تقابل الحرف الأول، والعين تقابل الثاني، واللام تقابل الثالث.',
    'البلاغة (علم البيان)': 'علم البيان يهتم بطرق التعبير عن المعنى الواحد بصور مختلفة، وأبوابه: التشبيه، الاستعارة، الكناية، والمجاز المرسل.',
    'البلاغة (علم المعاني)': 'يهتم بمطابقة الكلام لمقتضى الحال، ومن أبوابه: الخبر والإنشاء، الإيجاز والإطناب والمساواة، القصر، والوصل والفصل.',
    'البلاغة (علم البديع)': 'يهتم بجماليات الكلام اللفظية والمعنوية، ومنه: السجع، الجناس، الطباق، والمقابلة.',
    'الإعراب والبناء': 'الإعراب هو تغير أواخر الكلم باختلاف العوامل الداخلة عليها. البناء هو لزوم آخر الكلمة حالة واحدة مهما تغير موقعها في الجملة.',
    'الأدب العربي وعصور الأدب': 'ينقسم الأدب العربي إلى عصور: الجاهلي، الإسلامي والأموي، العباسي، الأندلسي، عصر الدول المتتابعة، والعصر الحديث.',
    'المعاجم العربية وطرق البحث': 'المعاجم هي كتب تجمع كلمات اللغة وتشرحها. من أشهرها: لسان العرب لابن منظور، والقاموس المحيط للفيروزآبادي. طرق البحث تختلف حسب ترتيب المعجم (أبجدي، أو حسب القافية).',
    'الخط العربي وأنواعه': 'الخط العربي فن إسلامي أصيل، ومن أنواعه: النسخ (خط المصاحف)، الرقعة (الأكثر تداولاً)، الخط الكوفي، والخط الديواني.'
  },
  'الوعظ': {
    'أعمال القلوب': 'هي الأصل في العبادة، وتشمل: الإخلاص، المحبة، الخوف، الرجاء، التوكل، الصبر، الشكر. قال ابن القيم: "أعمال القلوب هي المحركة لأعمال الجوارح".',
    'الاستعداد للموت': 'الموت هو الحقيقة الكبرى، والاستعداد له يكون بالتوبة النصوح، ورد المظالم، والإكثار من العمل الصالح، وترك المحرمات. قال ﷺ: "أكثروا ذكر هاذم اللذات".',
    'التوبة النصوح': 'شروطها: الإقلاع عن الذنب، الندم على ما فات، العزم على عدم العودة، ورد المظالم إلى أهلها. قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا تُوبُوا إِلَى اللَّهِ تَوْبَةً نَّصُوحًا}.',
    'بر الوالدين': 'هو من أعظم القربات بعد توحيد الله. قال تعالى: {وَقَضَى رَبُّكَ أَلَّا تَعْبُدُوا إِلَّا إِيَّاهُ وَبِالْوَالِدَيْنِ إِحْسَانًا}. ويشمل طاعتهما في غير معصية، والنفقة عليهما، والدعاء لهما.',
  }
};

const fatwaData: Record<string, { q: string; a: string; scholar: string }[]> = {
  'قسم الصلاة': [
    { q: 'ما حكم صلاة الجماعة في المسجد؟', a: 'صلاة الجماعة واجبة على الرجال القادرين في المسجد، وليست مجرد سنة مؤكدة، للأدلة الكثيرة من الكتاب والسنة.', scholar: 'ابن باز' },
    { q: 'هل تجوز الصلاة خلف من يرتكب بعض البدع؟', a: 'الصلاة خلف المبتدع صحيحة ما لم تصل بدعته إلى الكفر، لكن الصلاة خلف السني أولى وأفضل.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم من ترك الصلاة تهاوناً وكسلاً؟', a: 'من تركها جاحداً لوجوبها كفر بإجماع المسلمين، أما من تركها تهاوناً فالراجح أنه يكفر كفراً مخرجاً من الملة لقوله ﷺ: "بين الرجل وبين الشرك والكفر ترك الصلاة".', scholar: 'ابن باز' },
    { q: 'ما حكم قراءة الفاتحة للمأموم في الصلاة الجهرية؟', a: 'الراجح وجوب قراءتها على المأموم في السرية والجهرية لعموم قوله ﷺ: "لا صلاة لمن لم يقرأ بفاتحة الكتاب".', scholar: 'ابن باز' },
    { q: 'هل تجب الصلاة على من أغمي عليه يوماً أو يومين؟', a: 'نعم، يجب عليه القضاء إذا كان الإغماء يسيراً كاليوم واليومين، أما إذا طال كالأسبوع فلا قضاء عليه.', scholar: 'ابن باز' },
    { q: 'ما حكم الكلام سهواً في الصلاة؟', a: 'الكلام سهواً أو جهلاً لا يبطل الصلاة على الراجح، لكن يجب سجدتا السهو قبل السلام أو بعده.', scholar: 'ابن باز' },
    { q: 'هل يجوز للمسافر الجمع بين الصلوات دون قصر؟', a: 'نعم يجوز الجمع دون قصر، لكن السنة للمسافر أن يقصر الصلاة الرباعية إلى ركعتين.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الصلاة في السراويل الضيقة؟', a: 'إذا كانت تستر العورة فالصلاة صحيحة، لكن يكره لبس الضيق الذي يصف حجم العورة، والأولى لبس الواسع الساتر.', scholar: 'اللجنة الدائمة' },
    { q: 'هل تبطل الصلاة بالضحك؟', a: 'الضحك الذي يظهر فيه صوت (القهقهة) يبطل الصلاة بإجماع العلماء، أما التبسم فلا يبطلها.', scholar: 'ابن باز' },
    { q: 'ما حكم صلاة المنفرد خلف الصف؟', a: 'لا تصح صلاة المنفرد خلف الصف إذا وجد مكاناً في الصف، لقوله ﷺ: "لا صلاة لمنفرد خلف الصف".', scholar: 'ابن باز' },
    { q: 'ما حكم الصلاة في الثوب الذي أصابه طين الشوارع؟', a: 'الأصل في طين الشوارع الطهارة، إلا إذا علم يقيناً أنه اختلط بنجاسة، فالصلاة فيه صحيحة.', scholar: 'ابن عثيمين' },
    { q: 'هل يشرع سجود السهو في صلاة الجنازة؟', a: 'لا يشرع سجود السهو في صلاة الجنازة لأنها ليس فيها ركوع ولا سجود.', scholar: 'ابن باز' },
    { q: 'ما حكم تغطية الوجه للمرأة في الصلاة؟', a: 'السنة كشف الوجه في الصلاة للمرأة إذا لم يكن عندها أجانب، فإن كان عندها أجانب وجب عليها ستره.', scholar: 'اللجنة الدائمة' },
    { q: 'هل يجوز الالتفات في الصلاة؟', a: 'الالتفات اليسير للحاجة لا يبطل الصلاة، أما الالتفات الكثير لغير حاجة فيكره، والالتفات بجميع البدن يبطلها.', scholar: 'ابن باز' },
    { q: 'ما حكم الصلاة في الكنيسة؟', a: 'تكره الصلاة في الكنيسة لوجود الصور والتماثيل، لكن إذا اضطر المسلم إليها وصلى في مكان خال من الصور فصلاته صحيحة.', scholar: 'ابن عثيمين' },
    { q: 'هل تبطل الصلاة برفع البصر إلى السماء؟', a: 'رفع البصر إلى السماء في الصلاة محرم، وقد حذر منه النبي ﷺ، لكنه لا يبطل الصلاة عند جمهور العلماء.', scholar: 'ابن باز' },
    { q: 'ما حكم صلاة تحية المسجد والإمام يخطب الجمعة؟', a: 'يشرع لمن دخل والامام يخطب أن يصلي ركعتين خفيفتين قبل أن يجلس.', scholar: 'ابن باز' },
    { q: 'هل يجوز للمصلي أن يقرأ من المصحف في صلاة الفريضة؟', a: 'الأفضل القراءة مما يحفظ، لكن إذا احتاج للقراءة من المصحف في الفريضة جاز ذلك عند بعض العلماء، والجمهور على جوازه في النافلة.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الصلاة في مكان فيه صور؟', a: 'تكره الصلاة في مكان فيه صور معلقة أو منصوبة، لكن الصلاة صحيحة مع الكراهة.', scholar: 'اللجنة الدائمة' },
    { q: 'هل يشرع الدعاء بعد السلام من الصلاة؟', a: 'السنة الإتيان بالأذكار الواردة بعد السلام، أما الدعاء الجماعي فبدعة، والدعاء الفردي أحياناً لا بأس به.', scholar: 'ابن باز' }
  ],
  'قسم الوضوء': [
    { q: 'هل مس المرأة ينقض الوضوء؟', a: 'الراجح أن مس المرأة لا ينقض الوضوء مطلقاً، سواء كان بشهوة أو بغير شهوة، إلا إذا خرج منه شيء.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم المسح على الجوربين الخفيفين؟', a: 'يجوز المسح على الجوربين إذا كانا ساترين لمحل الفرض (الكعبين) وثابتين على القدمين، ولو كانا خفيفين على الراجح.', scholar: 'ابن باز' },
    { q: 'هل خروج الدم من الجسم ينقض الوضوء؟', a: 'خروج الدم من غير السبيلين لا ينقض الوضوء، سواء كان قليلاً أو كثيراً، إلا إذا خرج من السبيلين.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الوضوء من أكل لحم الإبل؟', a: 'أكل لحم الإبل ينقض الوضوء على الصحيح من قولي العلماء، لحديث جابر بن سمرة.', scholar: 'إسلام ويب' },
    { q: 'هل النوم ينقض الوضوء؟', a: 'النوم المستغرق الذي لا يبقى معه إدراك ينقض الوضوء، أما النعاس اليسير فلا ينقض.', scholar: 'ابن باز' },
    { q: 'ما حكم الشك في انتقاض الوضوء؟', a: 'اليقين لا يزول بالشك، فمن توضأ ثم شك هل انتقض وضوؤه أم لا، فهو على وضوئه حتى يتيقن الحدث.', scholar: 'ابن عثيمين' },
    { q: 'هل يجب تجديد الوضوء لكل صلاة؟', a: 'لا يجب، بل يستحب، ويجوز صلاة عدة صلوات بوضوء واحد ما لم ينتقض.', scholar: 'ابن باز' },
    { q: 'ما حكم الوضوء مع وجود طلاء الأظافر؟', a: 'طلاء الأظافر (المناكير) يمنع وصول الماء، فلا يصح الوضوء معه، ويجب إزالته قبل الوضوء.', scholar: 'ابن باز' },
    { q: 'هل مس الفرج ينقض الوضوء؟', a: 'مس الفرج باليد مباشرة من غير حائل ينقض الوضوء على الراجح من قولي العلماء.', scholar: 'ابن باز' },
    { q: 'ما حكم التسمية في أول الوضوء؟', a: 'التسمية واجبة مع الذكر وتسقط مع النسيان عند بعض العلماء، والجمهور على أنها سنة مؤكدة.', scholar: 'ابن عثيمين' },
    { q: 'هل القيء ينقض الوضوء؟', a: 'الراجح أن القيء لا ينقض الوضوء، سواء كان قليلاً أو كثيراً.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الوضوء من ماء البحر؟', a: 'ماء البحر طهور، يجوز الوضوء والغسل منه، لقوله ﷺ: "هو الطهور ماؤه الحل ميتته".', scholar: 'ابن باز' },
    { q: 'هل يجب غسل داخل العينين في الوضوء؟', a: 'لا يشرع غسل داخل العينين، بل هو من الغلو والتعنت الذي قد يضر بالبصر.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الكلام أثناء الوضوء؟', a: 'الكلام أثناء الوضوء مباح ولا يبطله، لكن الأفضل الانشغال بذكر الله والتدبر.', scholar: 'ابن باز' },
    { q: 'هل يجب تنشيف الأعضاء بعد الوضوء؟', a: 'التنشيف مباح، لا يجب ولا يكره، والأمر فيه واسع.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الوضوء بماء زمزم؟', a: 'يجوز الوضوء والغسل بماء زمزم، ولا كراهة في ذلك على الراجح.', scholar: 'ابن باز' },
    { q: 'هل يجزئ الوضوء عن الغسل؟', a: 'لا يجزئ الوضوء عن غسل الجنابة، بل يجب الغسل وتعميم البدن بالماء.', scholar: 'ابن باز' },
    { q: 'ما حكم الوضوء في الحمام (دورة المياه)؟', a: 'يجوز الوضوء في الحمام، وتكون التسمية في القلب أو سراً قبل الدخول أو عند البدء.', scholar: 'ابن عثيمين' },
    { q: 'هل قص الأظافر ينقض الوضوء؟', a: 'قص الأظافر أو حلق الشعر لا ينقض الوضوء.', scholar: 'ابن باز' },
    { q: 'ما حكم المسح على العمامة؟', a: 'يجوز المسح على العمامة إذا كانت ساترة للرأس ومدارة تحت الحنك أو لها ذؤابة.', scholar: 'ابن عثيمين' }
  ],
  'قسم الصيام': [
    { q: 'ما حكم استخدام بخاخ الربو للصائم؟', a: 'بخاخ الربو لا يفطر لأنه غاز يذهب إلى الرئة وليس طعاماً ولا شراباً ولا في معناهما.', scholar: 'ابن عثيمين' },
    { q: 'هل القيء غير المتعمد يفطر؟', a: 'من ذرعه القيء (غلبه) فلا قضاء عليه وصومه صحيح، أما من استقاء عمداً فعليه القضاء.', scholar: 'الأئمة الأربعة' },
    { q: 'ما حكم قطرة العين والأذن للصائم؟', a: 'الصحيح أنها لا تفطر، لأن العين والأذن ليستا منفذاً معتاداً للجوف، وحتى لو وجد طعمها في حلقه فلا تفطر.', scholar: 'ابن باز' },
    { q: 'هل بلع النخامة يفطر؟', a: 'بلع النخامة لا يفطر على الراجح، لكن يجب على الصائم إخراجها إذا وصلت إلى فمه.', scholar: 'إسلام سؤال وجواب' },
    { q: 'ما حكم استخدام معجون الأسنان للصائم؟', a: 'يجوز استخدامه مع الحذر الشديد من بلع شيء منه، والأفضل استخدامه قبل الفجر أو بعد الإفطار.', scholar: 'ابن باز' },
    { q: 'هل سحب الدم للتحليل يفطر؟', a: 'سحب الدم القليل للتحليل لا يفطر، أما الحجامة ففيها خلاف والراجح أنها تفطر.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم من أكل أو شرب ناسياً في نهار رمضان؟', a: 'صومه صحيح ولا قضاء عليه ولا كفارة، لقوله ﷺ: "فإنما أطعمه الله وسقاه".', scholar: 'ابن باز' },
    { q: 'هل العطر والبخور يفطران؟', a: 'العطر لا يفطر، أما البخور فيجوز شمه ولكن لا يجوز استنشاق دخانه عمداً لأنه جرم يصل للجوف.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم تذوق الطعام للحاجة؟', a: 'يجوز تذوق الطعام بطرف اللسان للحاجة مع بصقه وعدم بلع شيء منه.', scholar: 'ابن باز' },
    { q: 'هل الإبر المغذية تفطر؟', a: 'نعم، الإبر المغذية التي تقوم مقام الطعام والشراب تفطر، أما الإبر العلاجية غير المغذية فلا تفطر.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم صيام من طلع عليه الفجر وهو جنب؟', a: 'صومه صحيح، ويغتسل ويصلي الفجر، فقد كان النبي ﷺ يدركه الفجر وهو جنب من أهله ثم يغتسل ويصوم.', scholar: 'ابن باز' },
    { q: 'هل يجوز للصائم استخدام السواك في نهار رمضان؟', a: 'السواك سنة للصائم وغيره في جميع الأوقات، قبل الزوال وبعده.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم من جامع زوجته في نهار رمضان؟', a: 'عليه القضاء والكفارة المغلظة: عتق رقبة، فإن لم يجد فصيام شهرين متتابعين، فإن لم يجد فإطعام ستين مسكيناً.', scholar: 'ابن باز' },
    { q: 'هل يجوز الفطر للمسافر؟', a: 'نعم يجوز للمسافر الفطر والقضاء، سواء شق عليه السفر أو لم يشق.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم صيام الحامل والمرضع؟', a: 'يجوز لهما الفطر إذا خافتا على أنفسهما أو ولديهما، وعليهما القضاء عند جمهور العلماء.', scholar: 'ابن باز' },
    { q: 'هل قلع الضرس يفطر؟', a: 'قلع الضرس لا يفطر، لكن يجب الحذر من بلع الدم أو الماء الناتج عن العملية.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم استخدام قطرة الأنف للصائم؟', a: 'قطرة الأنف تفطر إذا وصلت إلى الجوف، لأن الأنف منفذ للمعدة، لقوله ﷺ: "وبالغ في الاستنشاق إلا أن تكون صائماً".', scholar: 'ابن باز' },
    { q: 'هل الكحل يفطر؟', a: 'الكحل لا يفطر الصائم على الراجح، ولو وجد طعمها في حلقه.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم من أفطر يوماً من رمضان بغير عذر؟', a: 'ارتكب كبيرة عظمى، ويجب عليه التوبة الصادقة والقضاء، وبعض العلماء يرى وجوب الكفارة.', scholar: 'ابن باز' },
    { q: 'هل التحاميل تفطر؟', a: 'التحاميل التي تؤخذ عن طريق الدبر لا تفطر لأنها ليست طعاماً ولا شراباً.', scholar: 'ابن عثيمين' }
  ],
  'قسم الزكاة': [
    { q: 'هل تجب الزكاة في الذهب المعد للاستعمال؟', a: 'الراجح وجوب الزكاة في الذهب والفضة إذا بلغا النصاب، حتى لو كانا للبس والزينة، لعموم الأدلة.', scholar: 'ابن باز' },
    { q: 'ما هو نصاب الذهب والفضة؟', a: 'نصاب الذهب 85 جراماً من الذهب الخالص، ونصاب الفضة 595 جراماً من الفضة الخالصة.', scholar: 'ابن عثيمين' },
    { q: 'هل يجوز دفع الزكاة لبناء المساجد؟', a: 'جمهور العلماء على أن الزكاة لا تصرف في بناء المساجد ولا المشاريع الخيرية العامة، بل تصرف للأصناف الثمانية المذكورة في القرآن.', scholar: 'الأئمة الأربعة' },
    { q: 'هل تجب الزكاة في مال اليتيم؟', a: 'تجب الزكاة في مال اليتيم إذا بلغ النصاب وحال عليه الحول، ويخرجها عنه وليه.', scholar: 'ابن باز' },
    { q: 'ما حكم إخراج الزكاة للأقارب؟', a: 'يجوز بل هو أفضل إذا كانوا من أهل الزكاة وليسوا ممن تجب عليك نفقتهم (كالوالدين والأبناء).', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في الراتب الشهري؟', a: 'لا تجب الزكاة في الراتب بمجرد قبضه، بل إذا ادخر منه ما يبلغ النصاب وحال عليه الحول.', scholar: 'ابن باز' },
    { q: 'ما حكم إخراج زكاة الفطر نقداً؟', a: 'السنة إخراجها طعاماً من قوت البلد، وذهب بعض العلماء كأبي حنيفة إلى جواز إخراجها نقداً للمصلحة.', scholar: 'إسلام ويب' },
    { q: 'هل تجب الزكاة في أسهم الشركات؟', a: 'نعم تجب الزكاة في الأسهم، وتختلف طريقة حسابها بحسب نوع الشركة (صناعية أو تجارية).', scholar: 'اللجنة الدائمة' },
    { q: 'ما حكم تأخير إخراج الزكاة بعد وجوبها؟', a: 'لا يجوز تأخير الزكاة بعد تمام الحول إلا لعذر شرعي، ويجب المبادرة بإخراجها فوراً.', scholar: 'ابن باز' },
    { q: 'هل تجب الزكاة في العقارات المعدة للسكن؟', a: 'لا زكاة في العقارات المعدة للسكن الشخصي، وإنما الزكاة في العقارات المعدة للتجارة والبيع.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في الألماس والأحجار الكريمة؟', a: 'لا تجب الزكاة في الألماس والأحجار الكريمة إلا إذا كانت معدة للتجارة.', scholar: 'ابن باز' },
    { q: 'ما حكم إخراج الزكاة لغير المسلم؟', a: 'لا يجوز دفع الزكاة لغير المسلم، إلا إذا كان من المؤلفة قلوبهم.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في السيارة الخاصة؟', a: 'لا تجب الزكاة في السيارة الخاصة ولا في أثاث المنزل المعد للاستعمال.', scholar: 'ابن باز' },
    { q: 'ما حكم دفع الزكاة للأخ الفقير؟', a: 'يجوز دفع الزكاة للأخ الفقير، وهي صدقة وصلة.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في مال الجمعية؟', a: 'تجب الزكاة على كل مشترك في الجمعية إذا بلغ نصيبه النصاب وحال عليه الحول.', scholar: 'ابن باز' },
    { q: 'ما حكم إخراج الزكاة عن الميت؟', a: 'إذا مات المسلم وعليه زكاة لم يخرجها، وجب إخراجها من تركته قبل توزيع الميراث.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في العسل؟', a: 'فيها خلاف، والراجح وجوب الزكاة في العسل إذا بلغ النصاب (650 كجم تقريباً) ومقداره العشر.', scholar: 'ابن باز' },
    { q: 'ما حكم نقل الزكاة من بلد إلى بلد؟', a: 'الأصل توزيع الزكاة في بلد المال، ويجوز نقلها لمصلحة شرعية راجحة كوجود أقارب أحوج.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في الأرض المشتراة لحفظ المال؟', a: 'إذا لم ينو بها التجارة فلا زكاة فيها، أما إذا نواها للتجارة ففيها الزكاة كل عام.', scholar: 'ابن باز' },
    { q: 'ما حكم دفع الزكاة للزوج الفقير؟', a: 'يجوز للمرأة أن تدفع زكاتها لزوجها الفقير لأنه لا تجب عليها نفقته.', scholar: 'ابن عثيمين' },
    { q: 'هل تجب الزكاة في الذهب المستعمل؟', a: 'نعم تجب فيه الزكاة إذا بلغ النصاب وحال عليه الحول على الراجح من قولي العلماء.', scholar: 'ابن باز' },
    { q: 'ما حكم إخراج الزكاة في صورة سلال غذائية؟', a: 'الأصل إخراج الزكاة نقداً للفقير ليتصرف فيها كيف يشاء، لكن إذا كان الفقير سفيهاً أو يخشى ضياع المال جاز إخراجها طعاماً.', scholar: 'ابن عثيمين' }
  ],
  'قضايا معاصرة': [
    { q: 'ما حكم العمل في البنوك الربوية؟', a: 'لا يجوز العمل في البنوك الربوية لما فيه من التعاون على الإثم والعدوان.', scholar: 'ابن باز' },
    { q: 'ما حكم العملات الرقمية (البيتكوين)؟', a: 'فيها خلاف كبير بين العلماء المعاصرين، والأحوط تجنبها لما فيها من الغرر والجهالة الكبيرة.', scholar: 'المجامع الفقهية' },
    { q: 'هل يجوز إجراء عمليات التجميل؟', a: 'تجوز إذا كانت لإزالة عيب أو تشوه، أما إذا كانت لمجرد زيادة الحسن وتغيير خلق الله فلا تجوز.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم التأمين التجاري؟', a: 'التأمين التجاري محرم لما فيه من الغرر والربا، والبديل هو التأمين التعاوني الإسلامي.', scholar: 'اللجنة الدائمة' },
    { q: 'ما حكم أطفال الأنابيب؟', a: 'تجوز بشروط مشددة، منها أن تكون النطفة من الزوج والبويضة من الزوجة وأن يتم الزرع في رحم الزوجة أثناء قيام الزوجية.', scholar: 'مجمع الفقه الإسلامي' },
    { q: 'هل يجوز التبرع بالأعضاء بعد الموت؟', a: 'يجوز إذا وصى بذلك وكان فيه نفع لمسلم، بشرط عدم البيع.', scholar: 'هيئة كبار العلماء' },
    { q: 'ما حكم الاستنساخ البشري؟', a: 'محرم بإجماع المجامع الفقهية لما فيه من المفاسد العظيمة وتغيير خلق الله.', scholar: 'مجمع الفقه الإسلامي' },
    { q: 'ما حكم الموسيقى والمعازف؟', a: 'المعازف محرمة عند جماهير العلماء والأئمة الأربعة، لقوله ﷺ: "ليكونن من أمتي أقوام يستحلون الحر والحرير والخمر والمعازف".', scholar: 'ابن باز' },
    { q: 'هل يجوز للمرأة السفر بدون محرم؟', a: 'الأصل عدم الجواز لقوله ﷺ: "لا تسافر المرأة إلا مع ذي محرم"، وأجاز بعض المعاصرين السفر للضرورة مع رفقة آمنة.', scholar: 'ابن باز' },
    { q: 'ما حكم التصوير الفوتوغرافي؟', a: 'فيه خلاف، والراجح جوازه للحاجة والضرورة، أما تصوير ذوات الأرواح للذكرى والزينة فمحل منع عند كثير من العلماء.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الشراء والبيع عن طريق الإنترنت؟', a: 'جائز إذا انضبطت الشروط الشرعية وانتفى الغرر والجهالة.', scholar: 'اللجنة الدائمة' },
    { q: 'هل يجوز استخدام برامج الكمبيوتر المقرصنة؟', a: 'لا يجوز لأنها حقوق مملوكة لأصحابها، ولا يجوز الاعتداء عليها إلا بإذنهم.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الإجهاض في الأسابيع الأولى؟', a: 'لا يجوز إلا لضرورة طبية معتبرة يقررها الأطباء الثقات.', scholar: 'اللجنة الدائمة' },
    { q: 'ما حكم التدخين؟', a: 'محرم بإجماع العلماء المعاصرين لما فيه من الضرر المحقق على الصحة والمال.', scholar: 'ابن باز' },
    { q: 'هل يجوز للمسلم الاحتفال بأعياد غير المسلمين؟', a: 'لا يجوز للمسلم المشاركة ولا التهنئة بأعيادهم الدينية الخاصة بهم.', scholar: 'ابن عثيمين' },
    { q: 'ما حكم القروض التعليمية بفوائد؟', a: 'محرمة لأنها ربا صريح، والضرورة تقدر بقدرها.', scholar: 'اللجنة الدائمة' },
    { q: 'هل يجوز العمل في شركات التأمين؟', a: 'لا يجوز العمل في شركات التأمين التجاري لما فيه من التعاون على المحرم.', scholar: 'ابن باز' },
    { q: 'ما حكم صبغ الشعر بالسواد؟', a: 'محرم للرجال والنساء على الراجح لقوله ﷺ: "وجنبوها السواد".', scholar: 'ابن عثيمين' },
    { q: 'ما حكم الوشم؟', a: 'محرم وهو من الكبائر، لقوله ﷺ: "لعن الله الواشمة والمستوشمة".', scholar: 'ابن باز' },
    { q: 'هل يجوز للمرأة العمل في مكان مختلط؟', a: 'الأصل أن تعمل المرأة في مكان خاص بالنساء، والاختلط محرم لما يترتب عليه من مفاسد.', scholar: 'اللجنة الدائمة' }
  ]
};

const ahlAllahData = {
  methods: [
    { 
      title: 'طريقة الحصون الخمسة', 
      content: 'تعتمد هذه الطريقة على خمسة أركان متكاملة تضمن الحفظ المتين:\n١. القراءة المستمرة (الورد اليومي): قراءة جزء يومياً على الأقل.\n٢. التحضير (التحضير الذهني): قراءة الصفحة المراد حفظها ١٥ مرة قبل الحفظ.\n٣. الحفظ الجديد: التركيز على حفظ وجه واحد يومياً.\n٤. المراجعة القريبة: مراجعة آخر ٢٠ وجهاً تم حفظها يومياً.\n٥. المراجعة البعيدة: مراجعة الأجزاء القديمة بشكل دوري (جزء يومياً).' 
    },
    { 
      title: 'طريقة التكرار المتباعد', 
      content: 'تعتمد على تكرار الآيات في فترات زمنية متباعدة لترسيخها في الذاكرة طويلة المدى. \n- كرر الآية ١٠ مرات فور حفظها.\n- كررها بعد ساعة.\n- كررها قبل النوم.\n- كررها في صلاة الفجر.\nهذا التوزيع يمنع النسيان السريع ويجعل الحفظ كالنقش على الحجر.' 
    },
    { 
      title: 'طريقة الربط الموضوعي', 
      content: 'تعتمد على فهم القصة أو الموضوع الذي تتحدث عنه الآيات. \n- افهم سبب النزول.\n- اربط بين نهاية الآية وبداية التي تليها من خلال المعنى.\n- تخيل المشهد الذي تصفه الآيات (خاصة في آيات القيامة والقصص).\nالفهم هو أقصر طريق للحفظ.' 
    },
    { 
      title: 'طريقة الكتابة (اللوح)', 
      content: 'كتابة الآيات تساعد في تفعيل الذاكرة الصورية والذاكرة العضلية.\n- اكتب الوجه كاملاً من المصحف.\n- حاول كتابته مرة أخرى غيباً.\n- صحح أخطاءك باللون الأحمر.\nهذه الطريقة كان يتبعها الشناقطة وعلماء المغرب العربي وهي من أمتن طرق الحفظ.' 
    }
  ],
  exams: [
    { id: 1, question: 'أكمل الآية: {إِيَّاكَ نَعْبُدُ وَإِيَّاكَ ...}', options: ['نَسْتَعِينُ', 'نَسْتَغْفِرُ', 'نَسْتَرْشِدُ'], answer: 'نَسْتَعِينُ' },
    { id: 2, question: 'ما الكلمة الناقصة: {قُلْ هُوَ اللَّهُ ...}', options: ['أَحَدٌ', 'الصَّمَدُ', 'الْوَاحِدُ'], answer: 'أَحَدٌ' },
    { id: 3, question: 'أكمل: {الْحَمْدُ لِلَّهِ رَبِّ ...}', options: ['الْعَالَمِينَ', 'النَّاسِ', 'الْمُؤْمِنِينَ'], answer: 'الْعَالَمِينَ' },
    { id: 4, question: 'ما الآية التالية لـ {فَبِأَيِّ آلَاءِ رَبِّكُمَا تُكَذِّبَانِ} في سورة الرحمن؟', options: ['مُدْهَامَّتَانِ', 'خَلَقَ الْإِنْسَانَ', 'عَلَّمَهُ الْبَيَانَ'], answer: 'مُدْهَامَّتَانِ' },
    { id: 5, question: 'أكمل الآية: {اهدِنَا الصِّرَاطَ ...}', options: ['المُستَقِيمَ', 'العَزِيزَ', 'الحَمِيدَ'], answer: 'المُستَقِيمَ' },
    { id: 6, question: 'ما الكلمة الناقصة: {مَالِكِ يَوْمِ ...}', options: ['الدِّينِ', 'الحِسابِ', 'القِيامَةِ'], answer: 'الدِّينِ' },
    { id: 7, question: 'أكمل: {وَالْعَصْرِ * إِنَّ الْإِنْسَانَ لَفِي ...}', options: ['خُسْرٍ', 'ضَلَالٍ', 'نَعِيمٍ'], answer: 'خُسْرٍ' },
    { id: 8, question: 'ما السورة التي تسمى "عروس القرآن"؟', options: ['الرحمن', 'يس', 'الواقعة'], answer: 'الرحمن' },
    { id: 9, question: 'أكمل: {إِنَّا أَعْطَيْنَاكَ ...}', options: ['الْكَوْثَرَ', 'النَّصْرَ', 'الْفَتْحَ'], answer: 'الْكَوْثَرَ' },
    { id: 10, question: 'ما الكلمة الناقصة: {فَصَلِّ لِرَبِّكَ ...}', options: ['وَانْحَرْ', 'وَاسْجُدْ', 'وَاقْتَرِبْ'], answer: 'وَانْحَرْ' }
  ]
};

const adhkarData: Record<string, { hadith: string; items: string[] }> = {
  'أذكار الصباح': {
    hadith: 'قال ﷺ: "من قال حين يصبح: سبحان الله وبحمده مائة مرة؛ حطت خطايا وإن كانت مثل زبد البحر".',
    items: [
      'أصبحنا وأصبح الملك لله والحمد لله، لا إله إلا الله وحده لا شريك له.',
      'اللهم بك أصبحنا وبك أمسينا وبك نحيا وبك نموت وإليك النشور.',
      'سيد الاستغفار: اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك...',
      'رضيت بالله رباً وبالإسلام ديناً وبمحمد ﷺ نبياً.',
      'يا حي يا قيوم برحمتك أستغيث أصلح لي شأني كله ولا تكلني إلى نفسي طرفة عين.'
    ]
  },
  'أذكار المساء': {
    hadith: 'قال ﷺ: "من قرأ بالآيتين من آخر سورة البقرة في ليلة كفتاه".',
    items: [
      'أمسينا وأمسى الملك لله والحمد لله، لا إله إلا الله وحده لا شريك له.',
      'اللهم بك أمسينا وبك أصبحنا وبك نحيا وبك نموت وإليك المصير.',
      'أعوذ بكلمات الله التامات من شر ما خلق.',
      'اللهم إني أسألك العفو والعافية في الدنيا والآخرة.',
      'بسم الله الذي لا يضر مع اسمه شيء في الأرض ولا في السماء وهو السميع العليم.'
    ]
  },
  'أذكار بعد الصلاة': {
    hadith: 'قال ﷺ: "من سبح الله في دبر كل صلاة ثلاثاً وثلاثين... غفرت خطاياه وإن كانت مثل زبد البحر".',
    items: [
      'أستغفر الله (ثلاثاً)، اللهم أنت السلام ومنك السلام تباركت يا ذا الجلال والإكرام.',
      'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير.',
      'اللهم لا مانع لما أعطيت ولا معطي لما منعت ولا ينفع ذا الجد منك الجد.',
      'قراءة آية الكرسي، والمعوذات (الإخلاص، الفلق، الناس).',
      'التسبيح (33)، التحميد (33)، التكبير (33)، وتمام المائة: لا إله إلا الله وحده لا شريك له.'
    ]
  },
  'أذكار النوم': {
    hadith: 'قال ﷺ: "إذا أويت إلى فراشك فاقرأ آية الكرسي... لن يزال عليك من الله حافظ".',
    items: [
      'باسمك ربي وضعت جنبي وبك أرفعه، إن أمسكت نفسي فارحمها وإن أرسلتها فاحفظها.',
      'اللهم قني عذابك يوم تبعث عبادك.',
      'باسمك اللهم أموت وأحيا.',
      'قراءة سورة الملك المنجية من عذاب القبر.',
      'نفث في الكفين وقراءة المعوذات ومسح ما استطاع من الجسد.'
    ]
  },
  'أذكار الاستيقاظ': {
    hadith: 'قال ﷺ: "الحمد لله الذي أحيانا بعد ما أماتنا وإليه النشور".',
    items: [
      'الحمد لله الذي أحيانا بعد ما أماتنا وإليه النشور.',
      'الحمد لله الذي عافاني في جسدي ورد علي روحي وأذن لي بذكره.',
      'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير، سبحان الله والحمد لله ولا إله إلا الله والله أكبر ولا حول ولا قوة إلا بالله.'
    ]
  },
  'فضل الذكر': {
    hadith: 'قال ﷺ: "ألا أنبئكم بخير أعمالكم... ذكر الله تعالى".',
    items: [
      'الذكر طمأنينة للقلب: {أَلَا بِذِكْرِ اللَّهِ تَطْمَئِنُّ الْقُلُوبُ}.',
      'الذكر سبب لذكر الله للعبد: {فَاذْكُرُونِي أَذْكُرْكُمْ}.',
      'الذكر يحط الخطايا ويرفع الدرجات.',
      'الذكر حصن حصين من الشيطان.',
      'الذاكرون الله كثيراً والذاكرات أعد الله لهم مغفرة وأجراً عظيماً.'
    ]
  }
};

// --- Farm Components ---
const PalmTree = React.memo(({ tree }: { tree: { id: number; pos: [number, number, number]; scale: number; dhikr?: string; emoji?: string } }) => {
  return (
    <motion.div
      initial={{ scale: 0, opacity: 0, y: -100 }}
      animate={{ scale: tree.scale, opacity: 1, y: 0 }}
      transition={{ type: 'spring', stiffness: 100, damping: 10 }}
      className="absolute pointer-events-none select-none flex flex-col items-center justify-end"
      style={{
        left: tree.pos[0],
        top: tree.pos[1],
        width: '80px',
        height: '100px',
        transform: 'translate(-50%, -100%)',
        zIndex: Math.floor(tree.pos[1])
      }}
    >
      <div className="text-5xl drop-shadow-2xl mb-1">{tree.emoji || '🌴'}</div>
      <div className="bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded-full border border-emerald-500/20 shadow-sm">
        <span className="text-[10px] font-bold text-emerald-900 quran-text whitespace-nowrap">{tree.dhikr}</span>
      </div>
    </motion.div>
  );
});

function SplashScreen({ onComplete }: { onComplete: () => void }) {
  return (
    <motion.div 
      initial={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center p-8"
    >
      <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        transition={{ duration: 1, ease: "easeOut" }}
        className="relative mb-12"
      >
        <div className="w-32 h-32 bg-emerald-500 rounded-[40px] rotate-12 flex items-center justify-center shadow-2xl shadow-emerald-500/40">
          <motion.div
            animate={{ rotate: -12 }}
            className="text-white"
          >
            <Star size={64} fill="currentColor" />
          </motion.div>
        </div>
        <motion.div 
          animate={{ scale: [1, 1.2, 1], opacity: [0.3, 0.6, 0.3] }}
          transition={{ duration: 3, repeat: Infinity }}
          className="absolute inset-0 bg-emerald-500 rounded-[40px] blur-2xl -z-10"
        />
      </motion.div>
      
      <motion.h1 
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.5 }}
        className="text-4xl font-bold text-white mb-4 tracking-tight"
      >
        حسـنات
      </motion.h1>
      
      <motion.p 
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.7 }}
        className="text-slate-400 text-center max-w-xs leading-relaxed mb-12 text-lg"
      >
        رفيقك في رحلة العلم والعبادة والذكر
      </motion.p>
      
      <motion.div 
        initial={{ width: 0 }}
        animate={{ width: "200px" }}
        transition={{ duration: 2, ease: "easeInOut" }}
        onAnimationComplete={() => setTimeout(onComplete, 500)}
        className="h-1 bg-emerald-500 rounded-full overflow-hidden"
      >
        <motion.div 
          animate={{ x: ["-100%", "100%"] }}
          transition={{ duration: 1.5, repeat: Infinity, ease: "linear" }}
          className="w-1/2 h-full bg-white/40"
        />
      </motion.div>
    </motion.div>
  );
}

// --- Main App Component ---
export default function App() {
  const [showSplash, setShowSplash] = useState(true);
  const [permissionsGranted, setPermissionsGranted] = useState({
    location: false,
    microphone: false,
    notifications: false
  });
  const [activeSection, setActiveSection] = useState('home');

  const requestAllPermissions = async () => {
    // Microphone
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      try {
        // First check if devices exist
        const devices = await navigator.mediaDevices.enumerateDevices();
        const hasMic = devices.some(device => device.kind === 'audioinput');
        
        if (hasMic) {
          await navigator.mediaDevices.getUserMedia({ audio: true });
          setPermissionsGranted(prev => ({ ...prev, microphone: true }));
        }
      } catch (e) {
        console.warn('Microphone permission denied or device not found', e);
      }
    }
    
    // Location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        () => setPermissionsGranted(prev => ({ ...prev, location: true })),
        (err) => console.warn('Location permission denied', err),
        { timeout: 10000 }
      );
    }

    // Notifications
    if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      try {
        const permission = await Notification.requestPermission();
        setPermissionsGranted(prev => ({ ...prev, notifications: permission === 'granted' }));
      } catch (e) {
        console.warn('Notification permission request failed', e);
      }
    }
  };
  const [selectedKnowledgeCategory, setSelectedKnowledgeCategory] = useState<string | null>(null);
  const [selectedSubCategory, setSelectedSubCategory] = useState<string | null>(null);
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [prayerTimes, setPrayerTimes] = useState<PrayerTimes | null>(null);
  const [verse, setVerse] = useState<Verse | null>(null);
  const [location, setLocation] = useState<string>('مكة المكرمة');
  const [trees, setTrees] = useState<{ id: number; pos: [number, number, number]; scale: number; dhikr?: string; emoji?: string }[]>([]);
  const dragX = React.useRef(0);
  const dragY = React.useRef(0);
  const [dhikrCount, setDhikrCount] = useState(0);
  const [customDhikr, setCustomDhikr] = useState('');
  const [misbahaCounts, setMisbahaCounts] = useState<Record<string, number>>({
    'سبحان الله': 0,
    'الحمد لله': 0,
    'لا إله إلا الله': 0,
    'الله أكبر': 0,
    'أستغفر الله': 0,
    'اللهم صل على محمد': 0
  });
  const [selectedAdhkarCategory, setSelectedAdhkarCategory] = useState<string | null>(null);
  const [selectedFatwaCategory, setSelectedFatwaCategory] = useState<string | null>(null);
  const [openFatwaIndex, setOpenFatwaIndex] = useState<number | null>(null);
  const [ahlAllahTab, setAhlAllahTab] = useState<'methods' | 'exams' | 'recitation'>('methods');
  const [currentExamIndex, setCurrentExamIndex] = useState(0);
  const [examScore, setExamScore] = useState(0);
  const [examQuestionsCount, setExamQuestionsCount] = useState(5);
  const [examSurah, setExamSurah] = useState<Surah | null>(null);
  const [examStatus, setExamStatus] = useState<'setup' | 'active' | 'finished'>('setup');
  const [examResults, setExamResults] = useState<{ q: string; user: string; correct: string; isRight: boolean }[]>([]);
  const [isListening, setIsListening] = useState(false);
  const [recognizedText, setRecognizedText] = useState('');
  const [recitationWords, setRecitationWords] = useState<string[]>([]);
  const [targetRecitationText, setTargetRecitationText] = useState('الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ');
  const [notificationDhikr, setNotificationDhikr] = useState<string | null>(null);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'info' } | null>(null);

  const showToast = (message: string, type: 'success' | 'info' = 'success') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 3000);
  };

  const normalizeArabic = (text: string) => {
    return text
      .replace(/[إأآا]/g, 'ا')
      .replace(/ة/g, 'ه')
      .replace(/ى/g, 'ي')
      .replace(/[\u064B-\u0652]/g, '')
      .replace(/[^\u0621-\u064A\s]/g, '')
      .trim();
  };

  // Quran Reader State
  const [surahs, setSurahs] = useState<Surah[]>([]);
  const [selectedSurah, setSelectedSurah] = useState<Surah | null>(null);
  const [ayahs, setAyahs] = useState<Ayah[]>([]);
  const [isLoadingQuran, setIsLoadingQuran] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [dailyProgress, setDailyProgress] = useState(0);
  const [nawawiProgress, setNawawiProgress] = useState<Record<number, boolean>>({});
  const [wrongWords, setWrongWords] = useState<string[]>([]);
  const [showRecitationTarget, setShowRecitationTarget] = useState(true);

  const shareOnWhatsApp = (title: string, content: string) => {
    const text = `*${title}*\n\n${content}\n\nتمت المشاركة من تطبيق حسنات`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
  };
  const [isAudioPlaying, setIsAudioPlaying] = useState(false);
  const [audioUrl, setAudioUrl] = useState<string | null>(null);
  const [lastRead, setLastRead] = useState<{ surah: string; number: number } | null>(null);
  const [bookmarks, setBookmarks] = useState<Bookmark[]>([]);
  const [activeAyahMenu, setActiveAyahMenu] = useState<number | null>(null);
  const [selectedReciter, setSelectedReciter] = useState<string>('ar.alafasy');
  const [selectedTafsir, setSelectedTafsir] = useState<string>('ar.muyassar');
  const [showReciterModal, setShowReciterModal] = useState(false);
  const [showTafsirModal, setShowTafsirModal] = useState(false);
  const [selectedAyahForTafsir, setSelectedAyahForTafsir] = useState<Ayah | null>(null);
  const [tafsirContent, setTafsirContent] = useState<string | null>(null);
  const [activeAyahAudio, setActiveAyahAudio] = useState<number | null>(null);
  const [quranMode, setQuranMode] = useState<'read' | 'listen' | 'tafsir'>('read');
  const [currentPage, setCurrentPage] = useState<number>(1);
  const [flipDirection, setFlipDirection] = useState<'next' | 'prev'>('next');
  const [showAboutModal, setShowAboutModal] = useState(false);
  const [showSupportModal, setShowSupportModal] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const ayahAudioRef = useRef<HTMLAudioElement | null>(null);
  const swiperRef = useRef<SwiperType | null>(null);

  const reciters: Reciter[] = [
    { id: 'ar.alafasy', name: 'مشاري العفاسي', server: 'https://server8.mp3quran.net/afs/' },
    { id: 'ar.muhammadluhaidan', name: 'محمد اللحيدان', server: 'https://server12.mp3quran.net/lhdan/' },
    { id: 'ar.husary', name: 'محمود خليل الحصري', server: 'https://server13.mp3quran.net/husr/' },
    { id: 'ar.minshawi', name: 'محمد صديق المنشاوي', server: 'https://server10.mp3quran.net/minsh/' },
    { id: 'ar.abdulbasitmurattal', name: 'عبدالباسط عبدالصمد', server: 'https://server7.mp3quran.net/basit/' },
    { id: 'ar.mahermuaiqly', name: 'ماهر المعيقلي', server: 'https://server12.mp3quran.net/maher/' },
    { id: 'ar.sudais', name: 'عبدالرحمن السديس', server: 'https://server11.mp3quran.net/sds/' },
    { id: 'ar.shuraym', name: 'سعود الشريم', server: 'https://server7.mp3quran.net/shur/' },
  ];

  const tafsirs: Tafsir[] = [
    { id: 'ar.muyassar', name: 'التفسير الميسر' }
  ];

  const dhikrs = [
    "سبحان الله وبحمده",
    "سبحان الله",
    "سبحان الله العظيم",
    "الله أكبر",
    "لا إله إلا الله",
    "الحمد لله"
  ];

  useEffect(() => {
    // Apply dark mode
    if (isDarkMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [isDarkMode]);

  useEffect(() => {
    if (swiperRef.current && currentPage) {
      swiperRef.current.slideTo(currentPage - 1);
    }
  }, [currentPage]);

  useEffect(() => {
    const randomDhikr = dhikrs[Math.floor(Math.random() * dhikrs.length)];
    setNotificationDhikr(randomDhikr);
    const timer = setTimeout(() => setNotificationDhikr(null), 5000);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    // Fetch Prayer Times with Geolocation
    const fetchPrayerTimes = async () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=4`);
            const data = await res.json();
            if (data.data) {
              setPrayerTimes(data.data.timings);
              setLocation('موقعك الحالي');
            }
          } catch (e) {
            console.error("Error fetching prayer times with geo", e);
            fetchMeccaTimes();
          }
        }, (error) => {
          console.warn("Geolocation denied", error);
          fetchMeccaTimes();
        });
      } else {
        fetchMeccaTimes();
      }
    };

    const fetchMeccaTimes = async () => {
      try {
        const res = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Mecca&country=Saudi+Arabia&method=4');
        const data = await res.json();
        if (data.data) {
          setPrayerTimes(data.data.timings);
        }
      } catch (e) {
        console.error("Error fetching mecca times", e);
      }
    };

    // Fetch Random Verse
    const fetchRandomVerse = async () => {
      try {
        const randomAyah = Math.floor(Math.random() * 6236) + 1;
        const res = await fetch(`https://api.alquran.cloud/v1/ayah/${randomAyah}/ar.alafasy`);
        const data = await res.json();
        if (data.data) {
          setVerse({
            text: data.data.text,
            surah: data.data.surah.name,
            number: data.data.numberInSurah
          });
        }
      } catch (e) {
        console.error("Error fetching verse", e);
      }
    };

    fetchPrayerTimes();
    fetchRandomVerse();
    fetchSurahs();
  }, []);

  const fetchSurahs = async () => {
    try {
      const res = await fetch('https://api.alquran.cloud/v1/surah');
      const data = await res.json();
      setSurahs(data.data);
    } catch (e) {
      console.error("Error fetching surahs", e);
    }
  };

  const fetchAyahs = async (surahNumber: number) => {
    setIsLoadingQuran(true);
    try {
      const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
      const data = await res.json();
      setAyahs(data.data.ayahs);
      if (data.data.ayahs.length > 0) {
        setCurrentPage(data.data.ayahs[0].page);
      }
    } catch (e) {
      console.error("Error fetching ayahs", e);
    } finally {
      setIsLoadingQuran(false);
    }
  };

  useEffect(() => {
    if (showTafsirModal && selectedAyahForTafsir) {
      fetchTafsir(selectedAyahForTafsir);
    }
  }, [selectedTafsir]);

  const fetchTafsir = async (ayah: Ayah) => {
    setTafsirContent(null);
    setSelectedAyahForTafsir(ayah);
    setShowTafsirModal(true);
    try {
      const res = await fetch(`https://api.alquran.cloud/v1/ayah/${selectedSurah?.number}:${ayah.numberInSurah}/${selectedTafsir}`);
      const data = await res.json();
      if (data.data) {
        setTafsirContent(data.data.text);
      }
    } catch (e) {
      console.error("Error fetching tafsir", e);
      setTafsirContent("عذراً، حدث خطأ أثناء تحميل التفسير.");
    }
  };

  const handleBookmarkClick = (bookmark: Bookmark) => {
    const surah = surahs.find(s => s.number === bookmark.surahNumber);
    if (surah) {
      handleSurahClick(surah);
      setQuranMode('read');
      // Fetch the page for this specific ayah
      fetch(`https://api.alquran.cloud/v1/ayah/${bookmark.surahNumber}:${bookmark.ayahNumber}`)
        .then(res => res.json())
        .then(data => {
          if (data.data) setCurrentPage(data.data.page);
        });
      
      // Still try to scroll if we are in text mode (listen/tafsir)
      setTimeout(() => {
        const element = document.getElementById(`ayah-${bookmark.ayahNumber}`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.classList.add('ring-4', 'ring-islamic-green/30');
          setTimeout(() => element.classList.remove('ring-4', 'ring-islamic-green/30'), 3000);
        }
      }, 1500);
    }
  };

  const playAyahAudio = (ayah: Ayah) => {
    if (ayahAudioRef.current) {
      ayahAudioRef.current.src = `https://cdn.islamic.network/quran/audio/128/${selectedReciter}/${selectedSurah?.number * 1000 + ayah.numberInSurah}.mp3`; // This is a placeholder logic, usually it's surah:ayah
      // Correct API for single ayah audio: https://api.alquran.cloud/v1/ayah/262/ar.alafasy
      const ayahId = `${selectedSurah?.number}:${ayah.numberInSurah}`;
      ayahAudioRef.current.src = `https://cdn.islamic.network/quran/audio/128/${selectedReciter}/${ayah.number}.mp3`;
      ayahAudioRef.current.play();
      setActiveAyahAudio(ayah.number);
    }
  };

  const handleSurahClick = (surah: Surah) => {
    setSelectedSurah(surah);
    setFlipDirection('next');
    fetchAyahs(surah.number);
    const reciterObj = reciters.find(r => r.id === selectedReciter);
    const paddedNumber = String(surah.number).padStart(3, '0');
    setAudioUrl(`${reciterObj?.server}${paddedNumber}.mp3`);
    setIsAudioPlaying(false);
    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
    }
    setLastRead({ surah: surah.name, number: surah.number });
    localStorage.setItem('hasanat_last_read', JSON.stringify({ surah: surah.name, number: surah.number }));
  };

  useEffect(() => {
    // Load persisted data
    const savedDhikrCount = localStorage.getItem('hasanat_dhikr_count');
    if (savedDhikrCount) setDhikrCount(parseInt(savedDhikrCount));

    const savedTrees = localStorage.getItem('hasanat_trees');
    if (savedTrees) setTrees(JSON.parse(savedTrees));

    const savedMisbaha = localStorage.getItem('hasanat_misbaha');
    if (savedMisbaha) setMisbahaCounts(JSON.parse(savedMisbaha));

    const savedLastRead = localStorage.getItem('hasanat_last_read');
    if (savedLastRead) setLastRead(JSON.parse(savedLastRead));
    
    const savedBookmarks = localStorage.getItem('hasanat_bookmarks');
    if (savedBookmarks) setBookmarks(JSON.parse(savedBookmarks));

    const savedDailyProgress = localStorage.getItem('hasanat_daily_progress');
    if (savedDailyProgress) setDailyProgress(parseInt(savedDailyProgress));

    const savedNawawi = localStorage.getItem('hasanat_nawawi_progress');
    if (savedNawawi) setNawawiProgress(JSON.parse(savedNawawi));

    // Request permissions
    requestAllPermissions();
  }, []);

  useEffect(() => {
    localStorage.setItem('hasanat_daily_progress', dailyProgress.toString());
  }, [dailyProgress]);

  useEffect(() => {
    localStorage.setItem('hasanat_nawawi_progress', JSON.stringify(nawawiProgress));
  }, [nawawiProgress]);

  useEffect(() => {
    localStorage.setItem('hasanat_dhikr_count', dhikrCount.toString());
  }, [dhikrCount]);

  useEffect(() => {
    localStorage.setItem('hasanat_trees', JSON.stringify(trees));
  }, [trees]);

  useEffect(() => {
    localStorage.setItem('hasanat_misbaha', JSON.stringify(misbahaCounts));
  }, [misbahaCounts]);

  useEffect(() => {
    if (selectedSurah) {
      const reciterObj = reciters.find(r => r.id === selectedReciter);
      const paddedNumber = String(selectedSurah.number).padStart(3, '0');
      setAudioUrl(`${reciterObj?.server}${paddedNumber}.mp3`);
      setIsAudioPlaying(false);
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.currentTime = 0;
      }
    }
  }, [selectedReciter, selectedSurah]);

  const setAyahBookmark = (ayahNumber: number, type: BookmarkType) => {
    if (selectedSurah) {
      const newBookmark: Bookmark = {
        surahName: selectedSurah.name,
        surahNumber: selectedSurah.number,
        ayahNumber: ayahNumber,
        type: type
      };
      
      // Remove any existing bookmark of the SAME TYPE (unique bookmark per color/type)
      const filtered = bookmarks.filter(b => b.type !== type);
      const updated = [...filtered, newBookmark];
      
      setBookmarks(updated);
      localStorage.setItem('hasanat_bookmarks', JSON.stringify(updated));
      setActiveAyahMenu(null);
    }
  };

  const getBookmarkColor = (type: BookmarkType) => {
    switch(type) {
      case 'fast': return 'bg-amber-400';
      case 'reflection': return 'bg-blue-400';
      case 'memorization': return 'bg-emerald-400';
      case 'general': return 'bg-rose-400';
      default: return 'bg-islamic-gold';
    }
  };

  const toggleAudio = () => {
    if (audioRef.current) {
      if (isAudioPlaying) {
        audioRef.current.pause();
      } else {
        audioRef.current.play();
      }
      setIsAudioPlaying(!isAudioPlaying);
    }
  };

  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'تطبيق حسنات',
          text: 'تطبيق إسلامي متكامل للقراءة والاستماع والتعلم',
          url: window.location.href,
        });
      } catch (err) {
        console.error('Error sharing:', err);
      }
    } else {
      alert('نظام المشاركة غير مدعوم في هذا المتصفح، يمكنك نسخ الرابط يدوياً.');
    }
  };

  const zones = [
    { name: "سبحان الله وبحمده", x: 1000, y: 1000, color: "rgba(16, 185, 129, 0.15)", emoji: "🌴" },
    { name: "سبحان الله", x: 3000, y: 1000, color: "rgba(59, 130, 246, 0.15)", emoji: "🌳" },
    { name: "سبحان الله العظيم", x: 1000, y: 3000, color: "rgba(245, 158, 11, 0.15)", emoji: "🌸" },
    { name: "الله أكبر", x: 3000, y: 3000, color: "rgba(239, 68, 68, 0.15)", emoji: "🌿" },
    { name: "لا إله إلا الله", x: 2000, y: 2000, color: "rgba(139, 92, 246, 0.15)", emoji: "🍀" },
    { name: "الحمد لله", x: 2000, y: 500, color: "rgba(236, 72, 153, 0.15)", emoji: "🌼" },
  ];

  const addTreeInZone = (dhikrText: string) => {
    const zone = zones.find(z => z.name === dhikrText);
    if (!zone) return;
    
    const zoneTrees = trees.filter(t => t.dhikr === dhikrText);
    if (zoneTrees.length >= 20) {
      showToast(`اكتمل هذا القسم (20 شجرة)`, 'info');
      return;
    }

    const newTree = {
      id: Date.now() + Math.random(),
      pos: [0, 0, 0] as [number, number, number],
      scale: 1,
      dhikr: dhikrText,
      emoji: zone.emoji
    };
    
    setTrees(prev => [...prev, newTree]);
    setDhikrCount(prev => prev + 1);
    setDailyProgress(prev => Math.min(prev + 0.5, 100));
    showToast(`تم زراعة ${zone.emoji} في قسم ${dhikrText}`, 'success');
    if (window.navigator.vibrate) window.navigator.vibrate(20);
  };

  if (showSplash) {
    return <SplashScreen onComplete={() => setShowSplash(false)} />;
  }

  return (
    <div className={`flex flex-col h-screen w-full overflow-hidden shadow-2xl relative transition-colors duration-300 bg-slate-900 text-slate-100`}>
      {/* Header */}
      <header className="p-6 flex items-center justify-between z-20 bg-slate-900/80 backdrop-blur-sm">
        <button 
          onClick={() => setActiveSection('settings')}
          className="p-2 bg-slate-800 rounded-full shadow-sm text-slate-500"
        >
          <Settings size={20} />
        </button>
        <h1 className="text-3xl font-bold text-emerald-500">حسنات</h1>
        <div className="w-10" />
      </header>

      {/* Main Content */}
      <main className="flex-1 overflow-y-auto pb-24 px-4 scroll-smooth">
        <AnimatePresence mode="wait">
          {activeSection === 'home' && (
            <motion.div
              key="home"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="space-y-6"
            >
              {/* Daily Progress Bar */}
              <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-black/5 dark:border-white/5">
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm font-bold text-slate-700 dark:text-slate-200">إنجازك اليومي</span>
                  <span className="text-xs font-bold text-emerald-500">{Math.round(dailyProgress)}%</span>
                </div>
                <div className="w-full bg-slate-100 dark:bg-slate-700 h-3 rounded-full overflow-hidden">
                  <motion.div 
                    initial={{ width: 0 }}
                    animate={{ width: `${dailyProgress}%` }}
                    className="h-full bg-gradient-to-r from-emerald-500 to-teal-500"
                  />
                </div>
                <p className="text-[10px] text-slate-400 mt-2 text-center">استمر في التسبيح والتعلم لرفع مستوى إنجازك</p>
              </div>

              {/* Random Verse */}
              <div className="text-center py-8 px-4 bg-islamic-green/5 dark:bg-emerald-500/10 rounded-3xl border border-islamic-green/10 dark:border-emerald-500/20">
                <p className="quran-text text-2xl text-islamic-green dark:text-emerald-400 leading-relaxed mb-4 italic">
                  "{verse?.text}"
                </p>
                <p className="text-xs text-islamic-green/60 dark:text-emerald-500/60">
                  سورة {verse?.surah} - آية {verse?.number}
                </p>
              </div>

              {/* Quran Options */}
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <button 
                    onClick={() => { setQuranMode('read'); setActiveSection('quran-reader'); }}
                    className="flex flex-col items-center justify-center p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 dark:border-white/5 hover:bg-islamic-green dark:hover:bg-emerald-600 hover:text-white transition-all group"
                  >
                    <Book className="mb-3 text-islamic-green dark:text-emerald-500 group-hover:text-white" size={32} />
                    <span className="font-bold dark:text-slate-200 group-hover:text-white">القرآن الكريم مكتوب</span>
                  </button>
                  <button 
                    onClick={() => { setQuranMode('listen'); setActiveSection('quran-reader'); }}
                    className="flex flex-col items-center justify-center p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 dark:border-white/5 hover:bg-islamic-green dark:hover:bg-emerald-600 hover:text-white transition-all group"
                  >
                    <Volume2 className="mb-3 text-islamic-green dark:text-emerald-500 group-hover:text-white" size={32} />
                    <span className="font-bold dark:text-slate-200 group-hover:text-white">استماع القرآن</span>
                  </button>
                </div>
                <button 
                  onClick={() => { setQuranMode('tafsir'); setActiveSection('quran-reader'); }}
                  className="w-full flex items-center justify-center gap-4 p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 dark:border-white/5 hover:bg-islamic-green dark:hover:bg-emerald-600 hover:text-white transition-all group"
                >
                  <BookOpen className="text-islamic-green dark:text-emerald-500 group-hover:text-white" size={32} />
                  <span className="font-bold text-xl dark:text-slate-200 group-hover:text-white">تفسير القرآن الكريم</span>
                </button>

                <button 
                  onClick={() => setActiveSection('adhkar')}
                  className="w-full flex items-center justify-center gap-4 p-6 bg-gradient-to-r from-islamic-green/10 to-emerald-500/10 dark:from-emerald-500/20 dark:to-teal-500/20 rounded-3xl shadow-sm border border-islamic-green/20 dark:border-emerald-500/30 hover:scale-[1.02] transition-all group"
                >
                  <Star className="text-islamic-green dark:text-emerald-500" size={32} />
                  <span className="font-bold text-xl text-slate-800 dark:text-white">الأذكار النبوية</span>
                </button>
              </div>
            </motion.div>
          )}

          {activeSection === 'adhkar' && (
            <motion.div
              key="adhkar"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              className="space-y-6"
            >
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setActiveSection('home')} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm text-slate-400">
                  <ChevronLeft className="rotate-180" />
                </button>
                <h2 className="text-xl font-bold text-islamic-green dark:text-emerald-500">الأذكار</h2>
                <div className="w-10" />
              </div>

              {selectedAdhkarCategory ? (
                <div className="space-y-6">
                  <button 
                    onClick={() => setSelectedAdhkarCategory(null)}
                    className="flex items-center gap-2 text-islamic-green dark:text-emerald-500 font-bold"
                  >
                    <ChevronLeft className="rotate-180" size={18} />
                    <span>العودة للأقسام</span>
                  </button>

                  <div className="p-6 bg-islamic-green/5 dark:bg-emerald-500/10 rounded-3xl border border-islamic-green/10 dark:border-emerald-500/20">
                    <p className="text-islamic-green dark:text-emerald-400 font-medium text-center leading-relaxed italic">
                      {adhkarData[selectedAdhkarCategory].hadith}
                    </p>
                  </div>

                  <div className="space-y-4">
                    {adhkarData[selectedAdhkarCategory].items.map((item, idx) => (
                      <div 
                        key={idx} 
                        onClick={() => {
                          addTreeInZone(selectedAdhkarCategory); // Use category as zone name if it matches
                          // If category doesn't match, just plant a random one
                          if (!zones.find(z => z.name === selectedAdhkarCategory)) {
                            const randomZone = zones[Math.floor(Math.random() * zones.length)];
                            addTreeInZone(randomZone.name);
                          }
                        }}
                        className="p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 dark:border-white/5 text-right cursor-pointer active:scale-[0.98] transition-transform"
                      >
                        <p className="text-lg text-slate-700 dark:text-slate-200 leading-relaxed quran-text">{item}</p>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 gap-4">
                  {Object.keys(adhkarData).map((cat) => (
                    <button
                      key={cat}
                      onClick={() => setSelectedAdhkarCategory(cat)}
                      className="flex items-center justify-between p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 dark:border-white/5 hover:border-islamic-green dark:hover:border-emerald-500 transition-all group"
                    >
                      <ChevronLeft className="text-slate-300 group-hover:text-islamic-green" />
                      <div className="flex items-center gap-4">
                        <span className="font-bold text-lg dark:text-slate-200">{cat}</span>
                        <div className="w-12 h-12 rounded-2xl bg-islamic-green/10 dark:bg-emerald-500/10 flex items-center justify-center text-islamic-green dark:text-emerald-500">
                          {cat.includes('صباح') && <Sunrise size={24} />}
                          {cat.includes('مساء') && <Sunset size={24} />}
                          {cat.includes('صلاة') && <List size={24} />}
                          {cat.includes('نوم') && <Bed size={24} />}
                          {cat.includes('استيقاظ') && <CloudSun size={24} />}
                          {cat.includes('فضل') && <Star size={24} />}
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </motion.div>
          )}

          {activeSection === 'ahl-allah' && (
            <motion.div
              key="ahl-allah"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="space-y-6"
            >
              <div className="text-center mb-8">
                <h2 className="text-3xl font-black text-emerald-500 mb-2">أهل الله</h2>
                <p className="text-slate-400 text-sm">خدمة كتاب الله حفظاً وتدبراً</p>
              </div>

              <div className="flex bg-slate-800/50 p-1 rounded-2xl mb-6">
                <button 
                  onClick={() => setAhlAllahTab('methods')}
                  className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${ahlAllahTab === 'methods' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400'}`}
                >
                  <Book size={16} />
                  طرق الحفظ
                </button>
                <button 
                  onClick={() => setAhlAllahTab('exams')}
                  className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${ahlAllahTab === 'exams' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400'}`}
                >
                  <Trophy size={16} />
                  امتحانات
                </button>
                <button 
                  onClick={() => setAhlAllahTab('recitation')}
                  className={`flex-1 py-3 rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 ${ahlAllahTab === 'recitation' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400'}`}
                >
                  <Mic size={16} />
                  تسميع ذكي
                </button>
              </div>

              {ahlAllahTab === 'methods' && (
                <div className="space-y-4">
                  {ahlAllahData.methods.map((m, i) => (
                    <div key={i} className="bg-slate-800/40 border border-white/5 p-6 rounded-[32px]">
                      <h3 className="text-emerald-400 font-bold mb-3 flex items-center gap-2">
                        <span className="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-[10px]">{i+1}</span>
                        {m.title}
                      </h3>
                      <p className="text-slate-300 text-sm leading-relaxed">{m.content}</p>
                    </div>
                  ))}
                </div>
              )}

              {ahlAllahTab === 'exams' && (
                <div className="space-y-6">
                  {examStatus === 'setup' && (
                    <div className="bg-slate-800/40 border border-white/5 p-6 rounded-[32px] space-y-6">
                      <h3 className="text-lg font-bold text-white text-center">إعداد الاختبار</h3>
                      
                      <div className="space-y-2">
                        <label className="text-xs text-slate-500 mr-2">اختر السورة:</label>
                        <select 
                          onChange={(e) => {
                            const s = surahs.find(x => x.number === parseInt(e.target.value));
                            setExamSurah(s || null);
                          }}
                          className="w-full bg-slate-900 border border-white/5 rounded-2xl p-4 text-slate-200 focus:ring-2 focus:ring-emerald-500"
                        >
                          <option value="">اختر سورة...</option>
                          {surahs.map(s => <option key={s.number} value={s.number}>{s.name}</option>)}
                        </select>
                      </div>

                      <div className="space-y-2">
                        <label className="text-xs text-slate-500 mr-2">عدد الأسئلة:</label>
                        <div className="grid grid-cols-3 gap-2">
                          {[5, 10, 20].map(n => (
                            <button 
                              key={n}
                              onClick={() => setExamQuestionsCount(n)}
                              className={`py-3 rounded-xl font-bold transition-all ${examQuestionsCount === n ? 'bg-emerald-500 text-white' : 'bg-slate-900 text-slate-500'}`}
                            >
                              {n}
                            </button>
                          ))}
                        </div>
                      </div>

                      <button 
                        disabled={!examSurah}
                        onClick={async () => {
                          if (!examSurah) return;
                          setIsLoadingQuran(true);
                          try {
                            const res = await fetch(`https://api.alquran.cloud/v1/surah/${examSurah.number}`);
                            const data = await res.json();
                            const verses = data.data.ayahs;
                            
                            // Generate random questions from verses
                            const questions = [];
                            for (let i = 0; i < examQuestionsCount; i++) {
                              const randomVerse = verses[Math.floor(Math.random() * verses.length)];
                              const words = randomVerse.text.split(' ');
                              if (words.length < 4) { i--; continue; } 
                              
                              const missingWordIndex = Math.floor(Math.random() * words.length);
                              const missingWord = words[missingWordIndex];
                              const questionText = words.map((w: string, idx: number) => idx === missingWordIndex ? '...' : w).join(' ');
                              
                              const distractors = [];
                              while (distractors.length < 2) {
                                const v = verses[Math.floor(Math.random() * verses.length)];
                                const w = v.text.split(' ')[Math.floor(Math.random() * v.text.split(' ').length)];
                                if (w !== missingWord && !distractors.includes(w)) distractors.push(w);
                              }
                              
                              questions.push({
                                question: `{ ${questionText} }`,
                                options: [missingWord, ...distractors].sort(() => Math.random() - 0.5),
                                answer: missingWord
                              });
                            }
                            
                            (window as any).generatedQuestions = questions;
                            setExamStatus('active');
                            setCurrentExamIndex(0);
                            setExamScore(0);
                            setExamResults([]);
                          } catch (e) {
                            alert('حدث خطأ في تحميل الأسئلة');
                          } finally {
                            setIsLoadingQuran(false);
                          }
                        }}
                        className="w-full py-4 bg-emerald-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-500/20 disabled:opacity-50"
                      >
                        ابدأ الاختبار الآن
                      </button>
                    </div>
                  )}

                  {examStatus === 'active' && (window as any).generatedQuestions && (
                    <div className="space-y-6">
                      <div className="flex justify-between items-center px-2">
                        <span className="text-xs text-slate-500">السؤال {currentExamIndex + 1} من {examQuestionsCount}</span>
                        <span className="text-xs font-bold text-emerald-500">النتيجة: {examScore}</span>
                      </div>
                      
                      <div className="bg-slate-800/40 border border-white/5 p-8 rounded-[40px] text-center">
                        <h3 className="text-xl font-bold text-white quran-text leading-loose">
                          {(window as any).generatedQuestions[currentExamIndex].question}
                        </h3>
                      </div>

                      <div className="grid grid-cols-1 gap-3">
                        {(window as any).generatedQuestions[currentExamIndex].options.map((opt: string, i: number) => (
                          <button
                            key={i}
                            onClick={() => {
                              const correct = (window as any).generatedQuestions[currentExamIndex].answer;
                              const isRight = opt === correct;
                              if (isRight) setExamScore(prev => prev + 1);
                              
                              setExamResults(prev => [...prev, {
                                q: (window as any).generatedQuestions[currentExamIndex].question,
                                user: opt,
                                correct: correct,
                                isRight: isRight
                              }]);

                              if (currentExamIndex + 1 < examQuestionsCount) {
                                setCurrentExamIndex(prev => prev + 1);
                              } else {
                                setExamStatus('finished');
                                setDailyProgress(prev => Math.min(prev + 10, 100));
                                const history = JSON.parse(localStorage.getItem('hasanat_exam_history') || '[]');
                                history.push({
                                  date: new Date().toISOString(),
                                  surah: examSurah?.name,
                                  score: Math.round(((isRight ? examScore + 1 : examScore) / examQuestionsCount) * 100)
                                });
                                localStorage.setItem('hasanat_exam_history', JSON.stringify(history));
                              }
                            }}
                            className="w-full py-4 bg-slate-700/50 hover:bg-emerald-500/20 border border-white/5 rounded-2xl font-bold text-slate-200 transition-all active:scale-95"
                          >
                            {opt}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {examStatus === 'finished' && (
                    <div className="space-y-6">
                      <div className="bg-emerald-500/10 border border-emerald-500/20 p-8 rounded-[40px] text-center">
                        <h3 className="text-3xl font-bold text-white mb-2">{Math.round((examScore / examQuestionsCount) * 100)}%</h3>
                        <p className="text-emerald-500 font-bold">النتيجة النهائية</p>
                        <p className="text-xs text-slate-500 mt-4">لقد أجبت على {examScore} من أصل {examQuestionsCount} أسئلة بشكل صحيح</p>
                      </div>

                      <div className="space-y-4">
                        <h4 className="font-bold text-slate-300 mr-2">تقرير الأداء:</h4>
                        {examResults.map((res, i) => (
                          <div key={i} className={`p-4 rounded-2xl border ${res.isRight ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-red-500/5 border-red-500/20'}`}>
                            <p className="text-xs text-slate-500 mb-2 quran-text">{res.q}</p>
                            <div className="flex justify-between items-center">
                              <span className={`text-sm font-bold ${res.isRight ? 'text-emerald-500' : 'text-red-500'}`}>إجابتك: {res.user}</span>
                              {!res.isRight && <span className="text-sm font-bold text-emerald-500">الصحيح: {res.correct}</span>}
                            </div>
                          </div>
                        ))}
                      </div>

                      <button 
                        onClick={() => setExamStatus('setup')}
                        className="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold"
                      >
                        اختبار جديد
                      </button>
                    </div>
                  )}
                </div>
              )}

              {ahlAllahTab === 'recitation' && (
                <div className="space-y-6">
                  <div className="bg-slate-800/40 border border-white/5 p-8 rounded-[40px] text-center min-h-[250px] flex flex-col justify-center relative">
                    {!isListening && recitationWords.length === 0 && (
                      <p className="text-xs text-slate-500 mb-4">اضغط على المايك وابدأ التسميع، ستظهر الكلمات عند نطقها بشكل صحيح</p>
                    )}
                    
                    <div className="flex flex-wrap justify-center gap-2 mb-8">
                      {targetRecitationText.split(' ').map((word, idx) => {
                        const cleanWord = word.replace(/[^\u0621-\u064A]/g, '');
                        const isCorrect = recitationWords.includes(cleanWord);
                        const isWrong = wrongWords.includes(cleanWord);
                        
                        return (
                          <motion.span 
                            key={idx}
                            initial={{ opacity: 1 }}
                            animate={{ 
                              opacity: isListening ? (isCorrect ? 1 : 0) : 1,
                              color: isCorrect ? '#34d399' : (isWrong ? '#f87171' : '#94a3b8'),
                              scale: isCorrect ? 1.1 : 1
                            }}
                            className="text-2xl font-bold quran-text transition-colors"
                          >
                            {word}
                          </motion.span>
                        );
                      })}
                    </div>
                    
                    <div className="flex justify-center mb-8">
                      <button 
                        onClick={() => {
                          if (!isListening) {
                            const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
                            if (SpeechRecognition) {
                              const recognition = new SpeechRecognition();
                              recognition.lang = 'ar-SA';
                              recognition.continuous = true;
                              recognition.interimResults = true;
                              
                              recognition.onstart = () => {
                                setIsListening(true);
                                setRecitationWords([]);
                                setWrongWords([]);
                                setRecognizedText('');
                              };
                              
                              recognition.onresult = (event: any) => {
                                let interimTranscript = '';
                                for (let i = event.resultIndex; i < event.results.length; ++i) {
                                  const transcript = event.results[i][0].transcript.trim().toLowerCase();
                                  if (event.results[i].isFinal) {
                                    const spokenWords = transcript.split(' ');
                                    const lastSpoken = normalizeArabic(spokenWords[spokenWords.length - 1]);
                                    
                                    const targetWords = targetRecitationText.split(' ').map(w => normalizeArabic(w));
                                    const nextWordIndex = recitationWords.length;
                                    const nextTargetWord = targetWords[nextWordIndex];

                                    if (lastSpoken === nextTargetWord || (nextTargetWord && lastSpoken.includes(nextTargetWord))) {
                                      setRecitationWords(prev => [...prev, targetRecitationText.split(' ')[nextWordIndex]]);
                                      setWrongWords([]);
                                    } else {
                                      setWrongWords(prev => [...prev, lastSpoken]);
                                      if (window.navigator.vibrate) window.navigator.vibrate(200);
                                    }
                                  } else {
                                    interimTranscript += transcript;
                                  }
                                }
                                setRecognizedText(interimTranscript);
                              };
                              
                              recognition.onend = () => setIsListening(false);
                              recognition.start();
                              (window as any).currentRecognition = recognition;
                            } else {
                              alert('متصفحك لا يدعم خاصية التعرف على الصوت');
                            }
                          } else {
                            if ((window as any).currentRecognition) (window as any).currentRecognition.stop();
                            setIsListening(false);
                          }
                        }}
                        className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${isListening ? 'bg-red-500 animate-pulse' : 'bg-emerald-500 shadow-lg shadow-emerald-500/20'}`}
                      >
                        <Mic size={32} className="text-white" />
                      </button>
                    </div>

                    {isListening && (
                      <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl">
                        <p className="text-[10px] text-emerald-500 mb-2">جاري الاستماع...</p>
                        <p className="text-sm font-bold text-white italic">{recognizedText || '...'}</p>
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => {
                        const randomSurah = surahs[Math.floor(Math.random() * surahs.length)];
                        fetch(`https://api.alquran.cloud/v1/surah/${randomSurah.number}`)
                          .then(r => r.json())
                          .then(d => {
                            const v = d.data.ayahs[Math.floor(Math.random() * d.data.ayahs.length)];
                            setTargetRecitationText(v.text);
                            setRecitationWords([]);
                          });
                      }}
                      className="flex-1 py-3 bg-slate-800 text-slate-300 rounded-xl text-xs font-bold"
                    >
                      تغيير الآية
                    </button>
                  </div>
                  <p className="text-[10px] text-slate-500 text-center italic">تعتمد هذه الخاصية على تقنية Web Speech API وتتطلب متصفحاً حديثاً ونطقاً واضحاً</p>
                </div>
              )}
            </motion.div>
          )}

          {activeSection === 'misbaha' && (
            <motion.div
              key="misbaha"
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.9 }}
              className="space-y-8 py-4"
            >
              <div className="text-center">
                <h2 className="text-3xl font-bold text-islamic-green dark:text-emerald-500 mb-2">المسبحة الإلكترونية</h2>
                <p className="text-slate-400 dark:text-slate-500">اذكر الله يذكرك</p>
              </div>

              <div className="grid grid-cols-1 gap-4">
                {misbahaCounts && Object.entries(misbahaCounts).map(([dhikr, count]) => (
                  <div key={dhikr} className="bg-white dark:bg-slate-800 rounded-[32px] p-6 shadow-sm border border-black/5 dark:border-white/5 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <button 
                        onClick={() => setMisbahaCounts(prev => ({ ...prev, [dhikr]: 0 }))}
                        className="p-3 text-slate-300 hover:text-red-500 transition-colors"
                      >
                        <RotateCcw size={20} />
                      </button>
                      <div className="text-center min-w-[60px]">
                        <span className="text-3xl font-bold text-islamic-green dark:text-emerald-400">{count}</span>
                      </div>
                    </div>
                    
                    <button 
                      onClick={() => {
                        setMisbahaCounts(prev => ({ ...prev, [dhikr]: prev[dhikr] + 1 }));
                        addTreeInZone(dhikr);
                      }}
                      className="flex-1 mr-4 py-4 px-6 bg-islamic-green/5 dark:bg-emerald-500/10 rounded-2xl text-right hover:bg-islamic-green/10 dark:hover:bg-emerald-500/20 transition-all active:scale-95"
                    >
                      <span className="text-xl font-bold text-slate-800 dark:text-white quran-text">{dhikr}</span>
                    </button>
                  </div>
                ))}
              </div>

              <button 
                onClick={() => setMisbahaCounts(Object.fromEntries(Object.keys(misbahaCounts).map(k => [k, 0])))}
                className="w-full py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-2xl font-bold flex items-center justify-center gap-2"
              >
                <RotateCcw size={18} />
                <span>تصفير جميع العدادات</span>
              </button>

              <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-black/5 dark:border-white/5 space-y-4">
                <h3 className="font-bold text-slate-700 dark:text-slate-300">إضافة ذكر مخصص</h3>
                <div className="flex gap-2">
                  <input 
                    type="text" 
                    value={customDhikr}
                    onChange={(e) => setCustomDhikr(e.target.value)}
                    placeholder="اكتب الذكر هنا..."
                    className="flex-1 bg-slate-50 dark:bg-slate-700 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-islamic-green"
                  />
                  <button 
                    onClick={() => {
                      if (customDhikr.trim()) {
                        setMisbahaCounts(prev => ({ ...prev, [customDhikr]: 0 }));
                        setCustomDhikr('');
                      }
                    }}
                    className="bg-islamic-green text-white p-3 rounded-xl"
                  >
                    <Plus size={20} />
                  </button>
                </div>
              </div>
            </motion.div>
          )}

          {activeSection === 'quran-reader' && (
            <motion.div
              key="quran-reader"
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              className="space-y-4 pb-12"
            >
              {!selectedSurah ? (
                <>
                  <div className="flex items-center justify-between mb-4">
                    <button onClick={() => setActiveSection('home')} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm text-slate-400">
                      <ChevronLeft className="rotate-180" />
                    </button>
                    <h2 className="text-xl font-bold text-islamic-green dark:text-emerald-500">القرآن الكريم</h2>
                    <div className="w-10" />
                  </div>

                  <div className="relative mb-6">
                    <Search className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500" size={18} />
                    <input
                      type="text"
                      placeholder="بحث عن سورة..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full bg-white dark:bg-slate-800 border border-black/5 dark:border-white/5 rounded-2xl py-3 pr-12 pl-4 focus:outline-none focus:ring-2 focus:ring-islamic-green/20 dark:focus:ring-emerald-500/20 shadow-sm dark:text-slate-200"
                    />
                  </div>

                  {lastRead && !searchQuery && (
                    <div className="grid grid-cols-2 gap-3 mb-6">
                      <div className="p-4 bg-islamic-gold/10 dark:bg-amber-500/10 rounded-2xl border border-islamic-gold/20 dark:border-amber-500/20 flex flex-col justify-between">
                        <div>
                          <p className="text-[10px] text-islamic-gold dark:text-amber-500 font-bold uppercase tracking-wider">آخر سورة</p>
                          <p className="font-bold text-slate-800 dark:text-slate-200 text-sm">{lastRead.surah}</p>
                        </div>
                        <button 
                          onClick={() => {
                            const s = surahs.find(x => x.number === lastRead.number);
                            if (s) handleSurahClick(s);
                          }}
                          className="mt-2 bg-islamic-gold dark:bg-amber-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-bold shadow-sm w-fit"
                        >
                          متابعة
                        </button>
                      </div>
                      
                      {bookmarks.length > 0 && (
                        <div className="p-4 bg-islamic-green/10 dark:bg-emerald-500/10 rounded-2xl border border-islamic-green/20 dark:border-emerald-500/20 flex flex-col justify-between">
                          <div>
                            <p className="text-[10px] text-islamic-green dark:text-emerald-500 font-bold uppercase tracking-wider">العلامات ({bookmarks.length})</p>
                            <div className="flex gap-1 mt-1">
                              {bookmarks.slice(-3).map((b, i) => (
                                <div key={i} className={`w-2 h-2 rounded-full ${getBookmarkColor(b.type)}`} />
                              ))}
                            </div>
                          </div>
                          <button 
                            onClick={() => {
                              const b = bookmarks[bookmarks.length - 1];
                              const s = surahs.find(x => x.number === b.surahNumber);
                              if (s) handleSurahClick(s);
                            }}
                            className="mt-2 bg-islamic-green dark:bg-emerald-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-bold shadow-sm w-fit"
                          >
                            آخر علامة
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                  <div className="grid grid-cols-1 gap-3">
                    {surahs
                      .filter(s => s.name.includes(searchQuery) || s.englishName.toLowerCase().includes(searchQuery.toLowerCase()))
                      .map((surah) => (
                      <button
                        key={surah.number}
                        onClick={() => handleSurahClick(surah)}
                        className="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-black/5 dark:border-white/5 hover:border-islamic-green/30 dark:hover:border-emerald-500/30 transition-all"
                      >
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 bg-islamic-green/10 dark:bg-emerald-500/10 rounded-full flex items-center justify-center text-islamic-green dark:text-emerald-500 font-bold text-sm">
                            {surah.number}
                          </div>
                          <div className="text-right">
                            <p className="font-bold text-slate-800 dark:text-slate-200">{surah.name}</p>
                            <p className="text-[10px] text-slate-400 dark:text-slate-500">{surah.numberOfAyahs} آية • {surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'}</p>
                          </div>
                        </div>
                        <ChevronLeft size={18} className="text-slate-300 dark:text-slate-600" />
                      </button>
                    ))}
                  </div>
                </>
              ) : (
                <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm min-h-[60vh]">
                  <div className="flex items-center justify-between mb-8">
                    <button onClick={() => setSelectedSurah(null)} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full text-slate-400">
                      <ChevronLeft className="rotate-180" />
                    </button>
                    <div className="text-center">
                      <h2 className="text-2xl font-bold text-islamic-green dark:text-emerald-500">{selectedSurah.name}</h2>
                      <div className="flex items-center justify-center gap-2 mt-1">
                        <button 
                          onClick={() => setShowReciterModal(true)}
                          className="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500 dark:text-slate-400 flex items-center gap-1"
                        >
                          <Volume2 size={10} />
                          {reciters.find(r => r.id === selectedReciter)?.name}
                        </button>
                        <button 
                          onClick={() => setShowTafsirModal(true)}
                          className="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500 dark:text-slate-400 flex items-center gap-1"
                        >
                          <Book size={10} />
                          {tafsirs.find(t => t.id === selectedTafsir)?.name}
                        </button>
                      </div>
                    </div>
                    <button 
                      onClick={toggleAudio}
                      className={`p-3 rounded-full shadow-lg transition-all ${isAudioPlaying ? 'bg-rose-500 text-white' : 'bg-islamic-green dark:bg-emerald-600 text-white'}`}
                    >
                      {isAudioPlaying ? <Moon size={20} /> : <Play size={20} />}
                    </button>
                    <a 
                      href={audioUrl} 
                      download={`${selectedSurah.name}.mp3`}
                      className="p-3 bg-slate-100 dark:bg-slate-700 rounded-full text-slate-600 dark:text-slate-300 shadow-sm hover:bg-slate-200 transition-all"
                      title="تحميل السورة"
                    >
                      <Download size={20} />
                    </a>
                  </div>

                  {audioUrl && (
                    <audio 
                      ref={audioRef} 
                      src={audioUrl} 
                      onEnded={() => setIsAudioPlaying(false)}
                      className="hidden"
                    />
                  )}

                  <audio 
                    ref={ayahAudioRef} 
                    onEnded={() => setActiveAyahAudio(null)}
                    className="hidden"
                  />

                  {quranMode === 'listen' ? (
                    <div className="flex flex-col items-center justify-center py-12 gap-8">
                      <div className="relative">
                        <div className={`w-48 h-48 rounded-full border-8 border-islamic-green/10 flex items-center justify-center transition-all ${isAudioPlaying ? 'scale-110 border-islamic-green/30' : ''}`}>
                          <div className={`w-40 h-40 rounded-full bg-islamic-green/5 flex items-center justify-center ${isAudioPlaying ? 'animate-pulse' : ''}`}>
                            <Volume2 size={64} className="text-islamic-green" />
                          </div>
                        </div>
                        {isAudioPlaying && (
                          <div className="absolute -inset-4 border-2 border-islamic-green/20 rounded-full animate-ping" />
                        )}
                      </div>

                      <div className="text-center space-y-2">
                        <h3 className="text-2xl font-bold text-slate-800 dark:text-slate-200">سورة {selectedSurah.name}</h3>
                        <p className="text-slate-500 dark:text-slate-400">بصوت القارئ {reciters.find(r => r.id === selectedReciter)?.name}</p>
                      </div>

                      <div className="flex items-center gap-6">
                        <button 
                          onClick={toggleAudio}
                          className={`w-20 h-20 rounded-full flex items-center justify-center shadow-2xl transition-all active:scale-90 ${isAudioPlaying ? 'bg-rose-500 text-white' : 'bg-islamic-green text-white'}`}
                        >
                          {isAudioPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} className="ml-1" fill="currentColor" />}
                        </button>
                      </div>

                      <div className="w-full max-w-xs bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                        <motion.div 
                          className="h-full bg-islamic-green"
                          initial={{ width: 0 }}
                          animate={{ width: isAudioPlaying ? '100%' : '0%' }}
                          transition={{ duration: 300, ease: "linear" }}
                        />
                      </div>
                      
                      <p className="text-xs text-slate-400 dark:text-slate-500">جاري تشغيل السورة كاملة من المصدر المباشر</p>
                    </div>
                  ) : quranMode === 'read' ? (
                    <div className="fixed inset-0 z-[150] bg-white dark:bg-slate-950 flex flex-col">
                      <div className="absolute top-0 left-0 right-0 p-4 z-[160] flex items-center justify-between bg-gradient-to-b from-black/20 to-transparent pointer-events-none">
                        <button 
                          onClick={() => setSelectedSurah(null)} 
                          className="p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md rounded-full text-slate-600 dark:text-slate-200 shadow-lg pointer-events-auto"
                        >
                          <ChevronLeft className="rotate-180" />
                        </button>
                        <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md px-4 py-2 rounded-full shadow-lg pointer-events-auto flex items-center gap-4">
                          <button 
                            onClick={() => swiperRef.current?.slidePrev()}
                            className="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors"
                          >
                            <ChevronLeft className="rotate-180" size={20} />
                          </button>
                          <span className="font-bold text-islamic-green dark:text-emerald-400 min-w-[80px] text-center">صفحة {currentPage}</span>
                          <button 
                            onClick={() => swiperRef.current?.slideNext()}
                            className="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors"
                          >
                            <ChevronLeft size={20} />
                          </button>
                        </div>
                        <button 
                          onClick={() => setQuranMode('tafsir')}
                          className="p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md rounded-full text-slate-600 dark:text-slate-200 shadow-lg pointer-events-auto"
                        >
                          <BookOpen size={20} />
                        </button>
                      </div>

                      <Swiper
                        onSwiper={(swiper) => swiperRef.current = swiper}
                        initialSlide={currentPage - 1}
                        onSlideChange={(swiper) => setCurrentPage(swiper.activeIndex + 1)}
                        className="w-full h-full"
                        dir="rtl"
                      >
                        {Array.from({ length: 604 }).map((_, i) => (
                          <SwiperSlide key={i} className="flex items-center justify-center">
                            <img 
                              src={`https://archive.org/download/quran-images-v2/page${i + 1}.png`} 
                              alt={`Page ${i + 1}`}
                              className="w-full h-full object-contain"
                              referrerPolicy="no-referrer"
                            />
                          </SwiperSlide>
                        ))}
                      </Swiper>
                    </div>
                  ) : isLoadingQuran ? (
                    <div className="flex flex-col items-center justify-center py-20 gap-4">
                      <div className="w-12 h-12 border-4 border-islamic-green/20 dark:border-emerald-500/20 border-t-islamic-green dark:border-t-emerald-500 rounded-full animate-spin" />
                      <p className="text-slate-400 dark:text-slate-500 animate-pulse">جاري تحميل الآيات...</p>
                    </div>
                  ) : !selectedSurah ? (
                    <div className="flex flex-col items-center justify-center py-20 text-center">
                      <BookOpen size={64} className="text-slate-200 mb-4" />
                      <h3 className="text-xl font-bold text-slate-400">اختر سورة للبدء</h3>
                    </div>
                  ) : (
                    <div className="space-y-8 quran-text text-3xl leading-[2.5] text-slate-800 dark:text-slate-200 text-center">
                      {selectedSurah.number !== 1 && selectedSurah.number !== 9 && (
                        <p className="text-islamic-green dark:text-emerald-500 mb-8">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ</p>
                      )}
                      <div className="flex flex-wrap justify-center gap-x-2 gap-y-6">
                        {ayahs.map((ayah) => {
                          const ayahBookmark = bookmarks.find(b => b.surahNumber === selectedSurah.number && b.ayahNumber === ayah.numberInSurah);
                          return (
                            <div key={ayah.number} id={`ayah-${ayah.numberInSurah}`} className="relative group/ayah flex flex-col items-center">
                              <span 
                                onClick={() => quranMode === 'tafsir' && fetchTafsir(ayah)}
                                className={`inline-block px-1 rounded-lg transition-colors cursor-pointer ${ayahBookmark ? `${getBookmarkColor(ayahBookmark.type)}/30 ring-1 ring-${getBookmarkColor(ayahBookmark.type)}/50` : ''} hover:bg-islamic-green/5 dark:hover:bg-emerald-500/5`}
                              >
                                {ayah.text}
                                <button 
                                  onClick={(e) => { e.stopPropagation(); setActiveAyahMenu(activeAyahMenu === ayah.number ? null : ayah.number); }}
                                  className={`inline-flex items-center justify-center w-8 h-8 mx-2 text-xs border border-islamic-gold/30 dark:border-amber-500/30 rounded-full font-sans font-bold transition-all ${ayahBookmark ? `${getBookmarkColor(ayahBookmark.type)} text-white border-none` : 'text-islamic-gold dark:text-amber-500 hover:bg-islamic-gold hover:text-white'} ${activeAyahAudio === ayah.number ? 'ring-2 ring-islamic-green dark:ring-emerald-500 animate-pulse' : ''}`}
                                >
                                  {ayah.numberInSurah}
                                </button>
                              </span>
                              
                              {activeAyahMenu === ayah.number && (
                                <div className="absolute bottom-full mb-2 bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-black/5 p-3 flex flex-col gap-3 z-50 animate-in fade-in slide-in-from-bottom-2 min-w-[160px]">
                                  <div className="flex gap-2 justify-center border-b border-black/5 pb-2">
                                    <button onClick={() => setAyahBookmark(ayah.numberInSurah, 'fast')} className="w-6 h-6 rounded-full bg-amber-400 border-2 border-white shadow-sm" title="ختمة سريعة" />
                                    <button onClick={() => setAyahBookmark(ayah.numberInSurah, 'reflection')} className="w-6 h-6 rounded-full bg-blue-400 border-2 border-white shadow-sm" title="تدبر" />
                                    <button onClick={() => setAyahBookmark(ayah.numberInSurah, 'memorization')} className="w-6 h-6 rounded-full bg-emerald-400 border-2 border-white shadow-sm" title="حفظ" />
                                    <button onClick={() => setAyahBookmark(ayah.numberInSurah, 'general')} className="w-6 h-6 rounded-full bg-rose-400 border-2 border-white shadow-sm" title="عام" />
                                  </div>
                                  <div className="grid grid-cols-2 gap-2">
                                    <button 
                                      onClick={() => fetchTafsir(ayah)}
                                      className="flex items-center justify-center gap-1 py-1.5 bg-slate-50 dark:bg-slate-700 rounded-lg text-[10px] font-bold text-slate-600 dark:text-slate-300"
                                    >
                                      <BookOpen size={12} />
                                      تفسير
                                    </button>
                                    <button 
                                      onClick={() => playAyahAudio(ayah)}
                                      className="flex items-center justify-center gap-1 py-1.5 bg-islamic-green/10 rounded-lg text-[10px] font-bold text-islamic-green"
                                    >
                                      <Play size={12} />
                                      استماع
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </motion.div>
          )}

          {activeSection === 'farm' && (
            <motion.div
              key="farm"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="fixed inset-0 z-0 overflow-hidden bg-emerald-900 flex flex-col"
            >
              {/* Top Section: The Forest Grid (65% height) */}
              <div className="relative h-[60vh] w-full bg-emerald-800 p-2 grid grid-cols-2 sm:grid-cols-3 grid-rows-3 sm:grid-rows-2 gap-2 overflow-hidden shadow-inner">
                {zones.map((zone) => (
                  <div 
                    key={zone.name} 
                    className="relative bg-emerald-700/30 rounded-2xl border border-white/5 flex flex-col items-center overflow-hidden"
                  >
                    {/* Zone Label */}
                    <div className="absolute top-1 left-0 right-0 text-center z-10">
                      <span className="text-[8px] sm:text-[10px] font-bold text-white/40 uppercase tracking-tighter">{zone.name}</span>
                    </div>

                    {/* Trees Grid within Zone (4x5 = 20 capacity) */}
                    <div className="w-full h-full p-4 pt-6 grid grid-cols-4 grid-rows-5 gap-1">
                      {trees.filter(t => t.dhikr === zone.name).map((tree, idx) => (
                        <motion.div
                          key={tree.id}
                          initial={{ scale: 0, y: 10 }}
                          animate={{ scale: 1, y: 0 }}
                          className="flex items-center justify-center text-xl sm:text-2xl select-none"
                          style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))' }}
                        >
                          {tree.emoji}
                        </motion.div>
                      ))}
                    </div>
                  </div>
                ))}

                {/* Farm Stats Overlay (Floating) */}
                <div className="absolute top-20 left-1/2 -translate-x-1/2 z-[50] pointer-events-none w-full px-6">
                  <motion.div 
                    initial={{ y: -20, opacity: 0 }}
                    animate={{ y: 0, opacity: 1 }}
                    className="bg-white/10 backdrop-blur-md rounded-2xl p-3 shadow-2xl border border-white/10 pointer-events-auto max-w-xs mx-auto flex items-center justify-between"
                  >
                    <div className="flex flex-col">
                      <h3 className="text-[10px] font-black text-white/60 uppercase">إجمالي الأشجار</h3>
                      <span className="text-xl font-black text-white">{trees.length}</span>
                    </div>
                    <div className="flex-1 mx-4">
                      <div className="w-full bg-white/10 rounded-full h-1.5 overflow-hidden">
                        <motion.div 
                          initial={{ width: 0 }}
                          animate={{ width: `${Math.min((trees.length / 120) * 100, 100)}%` }}
                          className="h-full bg-emerald-400"
                        />
                      </div>
                    </div>
                    <div className="text-right">
                      <span className="text-[10px] font-bold text-emerald-400">{Math.round((trees.length / 120) * 100)}%</span>
                    </div>
                  </motion.div>
                </div>
              </div>
              
              {/* Bottom Section: Controls (35% height) */}
              <div className="flex-1 bg-slate-950 border-t border-white/10 p-4 sm:p-6 z-[100] relative flex flex-col justify-between overflow-y-auto">
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <h4 className="text-white/80 font-bold text-xs">اضغط للزراعة في القسم المخصص:</h4>
                    <button 
                      onClick={() => {
                        if (confirm('هل تريد حقاً مسح جميع الأشجار في غابتك؟')) {
                          setTrees([]);
                          setDhikrCount(0);
                          localStorage.removeItem('hasanat_trees');
                        }
                      }}
                      className="text-[10px] text-red-500/60 font-bold hover:text-red-400 transition-colors"
                    >
                      إعادة ضبط الغابة
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {dhikrs.map((text) => (
                      <button
                        key={text}
                        onClick={() => addTreeInZone(text)}
                        className="bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-400 px-3 py-3 rounded-xl text-[10px] sm:text-xs font-bold shadow-lg active:scale-95 transition-all border border-emerald-500/20 flex flex-col items-center gap-1"
                      >
                        <span className="text-lg">{zones.find(z => z.name === text)?.emoji}</span>
                        <span className="truncate w-full text-center">{text}</span>
                      </button>
                    ))}
                  </div>
                </div>

                <p className="text-[9px] text-slate-600 text-center italic mt-4">
                  "من قال سبحان الله وبحمده غُرست له نخلة في الجنة"
                </p>
              </div>
            </motion.div>
          )}

          {activeSection === 'knowledge' && (
            <motion.div
              key="knowledge"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              className="space-y-4"
            >
              <div className="flex items-center justify-between mb-6">
                <div className="flex gap-2">
                  <button 
                    onClick={() => {
                      setSelectedFatwaCategory(null);
                      setSelectedKnowledgeCategory(null);
                      setSelectedSubCategory(null);
                    }}
                    className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${!selectedFatwaCategory ? 'bg-islamic-green text-white' : 'bg-slate-800 text-slate-500'}`}
                  >
                    مباحث العلم
                  </button>
                  <button 
                    onClick={() => {
                      setSelectedFatwaCategory('قسم الصلاة');
                      setSelectedKnowledgeCategory(null);
                    }}
                    className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${selectedFatwaCategory ? 'bg-islamic-green text-white' : 'bg-slate-800 text-slate-500'}`}
                  >
                    الفتاوى
                  </button>
                </div>
                <h2 className="text-xl font-bold text-islamic-green dark:text-emerald-500">
                  {selectedFatwaCategory ? 'الفتاوى الشرعية' : selectedSubCategory || selectedKnowledgeCategory || 'موسوعة العلم'}
                </h2>
              </div>

              {selectedFatwaCategory ? (
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-2 mb-4">
                    {Object.keys(fatwaData).map((cat) => (
                      <button
                        key={cat}
                        onClick={() => setSelectedFatwaCategory(cat)}
                        className={`p-3 rounded-2xl text-[10px] font-bold border transition-all ${selectedFatwaCategory === cat ? 'bg-emerald-500/20 border-emerald-500 text-emerald-500' : 'bg-slate-800/40 border-white/5 text-slate-400'}`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                  
                  <div className="space-y-3">
                    {fatwaData[selectedFatwaCategory].map((fatwa, idx) => (
                      <div key={idx} className="bg-slate-800/40 border border-white/5 rounded-2xl overflow-hidden">
                        <button
                          onClick={() => setOpenFatwaIndex(openFatwaIndex === idx ? null : idx)}
                          className="w-full p-4 flex items-center justify-between text-right"
                        >
                          <span className="font-bold text-slate-200 flex-1 ml-4">{fatwa.q}</span>
                          <Plus size={20} className={`text-emerald-500 transition-transform ${openFatwaIndex === idx ? 'rotate-45' : ''}`} />
                        </button>
                        <AnimatePresence>
                          {openFatwaIndex === idx && (
                            <motion.div initial={{ height: 0 }} animate={{ height: 'auto' }} exit={{ height: 0 }} className="overflow-hidden">
                              <div className="p-4 pt-0 border-t border-white/5">
                                <p className="text-slate-400 text-sm leading-relaxed mb-4">{fatwa.a}</p>
                                <div className="flex justify-between items-center">
                                  <button 
                                    onClick={() => shareOnWhatsApp(`فتوى: ${fatwa.q}`, fatwa.a)}
                                    className="flex items-center gap-1 text-[10px] text-emerald-500 hover:bg-emerald-500/10 px-2 py-1 rounded-lg"
                                  >
                                    <Share2 size={12} />
                                    مشاركة
                                  </button>
                                  <span className="text-[10px] font-bold bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full">المصدر: {fatwa.scholar}</span>
                                </div>
                              </div>
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </div>
                    ))}
                  </div>
                </div>
              ) : !selectedKnowledgeCategory ? (
                <div className="grid grid-cols-2 gap-4">
                  {[
                    { name: 'العقيدة', icon: <Moon className="text-blue-500" /> },
                    { name: 'الفقه', icon: <BookOpen className="text-emerald-500" /> },
                    { name: 'الحديث', icon: <Sun className="text-amber-500" /> },
                    { name: 'السيرة', icon: <MapPin className="text-rose-500" /> },
                    { name: 'اللغة العربية', icon: <GraduationCap className="text-indigo-500" /> },
                    { name: 'الوعظ', icon: <Volume2 className="text-purple-500" /> },
                  ].map((item) => (
                    <button
                      key={item.name}
                      onClick={() => setSelectedKnowledgeCategory(item.name)}
                      className="flex flex-col items-center p-6 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-black/5 hover:shadow-md transition-shadow"
                    >
                      <div className="mb-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-2xl">
                        {item.icon}
                      </div>
                      <span className="font-bold text-slate-700 dark:text-slate-200">{item.name}</span>
                    </button>
                  ))}
                </div>
              ) : !selectedSubCategory ? (
                <div className="space-y-3">
                  {knowledgeData[selectedKnowledgeCategory] ? Object.keys(knowledgeData[selectedKnowledgeCategory]).map((sub, i) => (
                    <button 
                      key={i} 
                      onClick={() => setSelectedSubCategory(sub)}
                      className="w-full text-right p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-black/5 hover:border-islamic-green/30 transition-all flex items-center justify-between"
                    >
                      <span className="font-bold text-slate-700 dark:text-slate-200">{sub}</span>
                      <ChevronLeft size={16} className="text-slate-300" />
                    </button>
                  )) : (
                    <div className="text-center py-20 text-slate-400 italic">
                      جاري إضافة المحتوى لهذا القسم...
                    </div>
                  )}
                </div>
              ) : (
                <motion.div 
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-black/5"
                >
                  {selectedSubCategory?.includes('الأربعين النووية') && (
                    <button 
                      onClick={() => {
                        const idx = parseInt(selectedSubCategory.match(/\d+/)?.[0] || '0');
                        const isDone = !!nawawiProgress[idx];
                        setNawawiProgress(prev => ({ ...prev, [idx]: !isDone }));
                        if (!isDone) setDailyProgress(prev => Math.min(prev + 5, 100));
                      }}
                      className={`w-full py-3 rounded-xl font-bold transition-all mb-6 flex items-center justify-center gap-2 ${nawawiProgress[parseInt(selectedSubCategory.match(/\d+/)?.[0] || '0')] ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}
                    >
                      {nawawiProgress[parseInt(selectedSubCategory.match(/\d+/)?.[0] || '0')] ? (
                        <><Check size={18} /> تم الحفظ والقراءة</>
                      ) : (
                        'تحديد كمقروء ومحفوظ'
                      )}
                    </button>
                  )}
                  <p className="text-slate-700 dark:text-slate-200 leading-relaxed text-lg text-right mb-6">
                    {knowledgeData[selectedKnowledgeCategory][selectedSubCategory]}
                  </p>
                  <div className="flex justify-end">
                    <button 
                      onClick={() => shareOnWhatsApp(selectedSubCategory, knowledgeData[selectedKnowledgeCategory][selectedSubCategory])}
                      className="flex items-center gap-2 bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/20"
                    >
                      <Share2 size={14} />
                      مشاركة عبر الواتساب
                    </button>
                  </div>
                </motion.div>
              )}
            </motion.div>
          )}
          {activeSection === 'settings' && (
            <motion.div
              key="settings"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 20 }}
              className="space-y-6"
            >
              <div className="flex items-center justify-between mb-6">
                <button onClick={() => setActiveSection('home')} className="p-2 bg-white dark:bg-slate-800 rounded-full shadow-sm text-slate-400">
                  <ChevronLeft className="rotate-180" />
                </button>
                <h2 className="text-xl font-bold text-islamic-green dark:text-emerald-500">الإعدادات والخيارات</h2>
                <div className="w-10" />
              </div>

              <div className="bg-white dark:bg-slate-800 rounded-3xl overflow-hidden shadow-sm border border-black/5">
                <div className="p-4 border-b border-black/5 flex items-center justify-between opacity-50">
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-amber-100 text-amber-600 rounded-xl">
                      <Moon size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">الوضع الليلي (مفعل دائماً)</span>
                  </div>
                  <div className="w-12 h-6 rounded-full bg-islamic-green relative">
                    <div className="absolute top-1 w-4 h-4 bg-white rounded-full right-7" />
                  </div>
                </div>

                <button 
                  onClick={handleShare}
                  className="w-full p-4 border-b border-black/5 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-blue-100 text-blue-600 rounded-xl">
                      <Share2 size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">مشاركة التطبيق</span>
                  </div>
                  <ChevronLeft size={18} className="text-slate-300" />
                </button>

                <button 
                  onClick={() => setShowSupportModal(true)}
                  className="w-full p-4 border-b border-black/5 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-emerald-100 text-emerald-600 rounded-xl">
                      <HelpCircle size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">الدعم والمساعدة</span>
                  </div>
                  <ChevronLeft size={18} className="text-slate-300" />
                </button>

                <button 
                  onClick={() => setShowAboutModal(true)}
                  className="w-full p-4 border-b border-black/5 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-purple-100 text-purple-600 rounded-xl">
                      <Info size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">حول التطبيق</span>
                  </div>
                  <ChevronLeft size={18} className="text-slate-300" />
                </button>

                <a 
                  href="https://instagram.com/is_d03" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="w-full p-4 border-b border-black/5 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-pink-100 text-pink-600 rounded-xl">
                      <User size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">تابعني على انستقرام</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">is_d03</span>
                    <ChevronLeft size={18} className="text-slate-300" />
                  </div>
                </a>

                <button 
                  onClick={() => {
                    if (confirm('هل أنت متأكد من رغبتك في مسح جميع الأشجار في المزرعة؟')) {
                      setTrees([]);
                      setDhikrCount(0);
                    }
                  }}
                  className="w-full p-4 border-b border-black/5 flex items-center justify-between hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-red-100 text-red-600 rounded-xl">
                      <Trash2 size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">مسح المزرعة (لتحسين الأداء)</span>
                  </div>
                  <ChevronLeft size={18} className="text-slate-300" />
                </button>

                <button 
                  onClick={() => {
                    if (!document.fullscreenElement) {
                      document.documentElement.requestFullscreen();
                    } else {
                      document.exitFullscreen();
                    }
                  }}
                  className="w-full p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-slate-100 text-slate-600 rounded-xl">
                      <Maximize size={20} />
                    </div>
                    <span className="font-bold text-slate-700 dark:text-slate-200">وضع ملء الشاشة</span>
                  </div>
                  <ChevronLeft size={18} className="text-slate-300" />
                </button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </main>

      {/* Modals */}
      <AnimatePresence>
        {showReciterModal && (
          <div className="fixed inset-0 z-[100] flex items-end justify-center p-4 bg-black/40 backdrop-blur-sm">
            <motion.div 
              initial={{ y: '100%' }}
              animate={{ y: 0 }}
              exit={{ y: '100%' }}
              className="w-full max-w-md bg-white dark:bg-slate-900 rounded-t-[40px] p-8 shadow-2xl"
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-xl font-bold text-slate-800 dark:text-white">اختر القارئ</h3>
                <button onClick={() => setShowReciterModal(false)} className="text-slate-400">إغلاق</button>
              </div>
              <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                {reciters.map((r) => (
                  <button 
                    key={r.id}
                    onClick={() => {
                      setSelectedReciter(r.id);
                      setShowReciterModal(false);
                      if (isAudioPlaying) {
                        setIsAudioPlaying(false);
                        if (audioRef.current) audioRef.current.pause();
                      }
                    }}
                    className={`w-full p-4 rounded-2xl flex items-center justify-between transition-all ${selectedReciter === r.id ? 'bg-islamic-green text-white shadow-lg' : 'bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200'}`}
                  >
                    <span className="font-bold">{r.name}</span>
                    {selectedReciter === r.id && <Check size={18} />}
                  </button>
                ))}
              </div>
            </motion.div>
          </div>
        )}

        {showTafsirModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
            <motion.div 
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="w-full max-w-md bg-white dark:bg-slate-900 rounded-[40px] p-8 shadow-2xl max-h-[80vh] flex flex-col"
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-xl font-bold text-slate-800 dark:text-white">التفسير</h3>
                <button onClick={() => setShowTafsirModal(false)} className="text-slate-400">إغلاق</button>
              </div>
              
              {tafsirs.length > 1 && (
                <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                  {tafsirs.map((t) => (
                    <button 
                      key={t.id}
                      onClick={() => setSelectedTafsir(t.id)}
                      className={`whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all ${selectedTafsir === t.id ? 'bg-islamic-green text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}
                    >
                      {t.name}
                    </button>
                  ))}
                </div>
              )}

              <div className="flex-1 overflow-y-auto text-right">
                {selectedAyahForTafsir ? (
                  <div className="space-y-4">
                    <div className="p-4 bg-islamic-green/5 dark:bg-emerald-500/5 rounded-2xl border border-islamic-green/10 dark:border-emerald-500/10">
                      <p className="quran-text text-xl text-islamic-green dark:text-emerald-400 leading-relaxed">
                        {selectedAyahForTafsir.text}
                      </p>
                      <p className="text-[10px] text-islamic-green/60 dark:text-emerald-500/60 mt-2">آية {selectedAyahForTafsir.numberInSurah}</p>
                    </div>
                    <div className="text-slate-700 dark:text-slate-300 leading-relaxed text-lg">
                      {tafsirContent || (
                        <div className="flex justify-center py-4">
                          <div className="w-6 h-6 border-2 border-islamic-green/20 border-t-islamic-green rounded-full animate-spin" />
                        </div>
                      )}
                    </div>
                    
                    <div className="flex items-center justify-between pt-6 mt-6 border-t border-black/5 dark:border-white/5">
                      <button 
                        disabled={selectedAyahForTafsir.numberInSurah === ayahs.length}
                        onClick={() => {
                          const next = ayahs.find(a => a.numberInSurah === selectedAyahForTafsir.numberInSurah + 1);
                          if (next) fetchTafsir(next);
                        }}
                        className="flex items-center gap-2 text-islamic-green dark:text-emerald-500 font-bold disabled:opacity-30"
                      >
                        <ChevronLeft size={18} />
                        <span>الآية التالية</span>
                      </button>
                      <button 
                        disabled={selectedAyahForTafsir.numberInSurah === 1}
                        onClick={() => {
                          const prev = ayahs.find(a => a.numberInSurah === selectedAyahForTafsir.numberInSurah - 1);
                          if (prev) fetchTafsir(prev);
                        }}
                        className="flex items-center gap-2 text-islamic-green dark:text-emerald-500 font-bold disabled:opacity-30"
                      >
                        <span>الآية السابقة</span>
                        <ChevronLeft size={18} className="rotate-180" />
                      </button>
                    </div>
                  </div>
                ) : (
                  <p className="text-center text-slate-400 italic py-10">اختر آية لعرض تفسيرها</p>
                )}
              </div>
            </motion.div>
          </div>
        )}

        {showAboutModal && (
          <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
            <motion.div 
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="w-full max-w-md bg-white dark:bg-slate-900 rounded-[40px] p-8 shadow-2xl text-center"
            >
              <div className="w-20 h-20 bg-islamic-green/10 rounded-3xl flex items-center justify-center mx-auto mb-6">
                <h1 className="text-4xl font-bold text-islamic-green">ح</h1>
              </div>
              <h3 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">تطبيق حسنات</h3>
              <p className="text-slate-500 dark:text-slate-400 mb-6 leading-relaxed">
                تطبيق إسلامي يهدف لمساعدة المسلم في حياته اليومية من خلال تلاوة القرآن وتعلم العلوم الشرعية وتنمية مزرعة الحسنات الافتراضية.
              </p>
              <div className="space-y-3 mb-8">
                <div className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                  <span className="text-slate-400">الإصدار</span>
                  <span className="font-bold text-slate-700 dark:text-slate-200">1.0.0</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-2xl">
                  <span className="text-slate-400">المطور</span>
                  <span className="font-bold text-slate-700 dark:text-slate-200">فريق حسنات</span>
                </div>
                <a 
                  href="https://instagram.com/is_d03" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="flex justify-between items-center p-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-2xl hover:scale-[1.02] transition-transform"
                >
                  <span className="text-purple-600 dark:text-purple-400 font-bold">تابعني على انستقرام</span>
                  <span className="font-bold text-slate-700 dark:text-slate-200">is_d03</span>
                </a>
              </div>
              <button 
                onClick={() => setShowAboutModal(false)}
                className="w-full py-4 bg-islamic-green text-white rounded-2xl font-bold shadow-lg shadow-islamic-green/20"
              >
                إغلاق
              </button>
            </motion.div>
          </div>
        )}

        {showSupportModal && (
          <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
            <motion.div 
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              className="w-full max-w-md bg-slate-900 rounded-[40px] p-8 shadow-2xl border border-white/5"
            >
              <h3 className="text-2xl font-bold text-white mb-6 text-center">الدعم والمساعدة</h3>
              <div className="space-y-4 mb-8">
                <p className="text-slate-400 text-right leading-relaxed">
                  إذا واجهت أي مشكلة أو كان لديك اقتراح لتحسين التطبيق، يسعدنا تواصلك معنا عبر البريد الإلكتروني:
                </p>
                <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl text-center">
                  <a href="mailto:asmaeldyab5@gmail.com" className="font-bold text-emerald-400 text-lg">
                    asmaeldyab5@gmail.com
                  </a>
                </div>
                <p className="text-xs text-slate-500 text-center italic">نسعى دائماً لتقديم أفضل تجربة لمستخدمينا</p>
              </div>
              <button 
                onClick={() => setShowSupportModal(false)}
                className="w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform"
              >
                فهمت
              </button>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      {/* Navigation */}
      <nav className={`fixed bottom-6 left-6 right-6 backdrop-blur-xl rounded-3xl shadow-2xl border p-1 flex justify-around items-center z-50 transition-colors duration-300 ${isDarkMode ? 'bg-slate-800/90 border-white/5' : 'bg-white/90 border-black/5'}`}>
        <button
          onClick={() => setActiveSection('home')}
          className={`flex flex-col items-center p-2 rounded-2xl transition-all ${activeSection === 'home' ? 'bg-islamic-green dark:bg-emerald-600 text-white shadow-lg' : 'text-slate-400 dark:text-slate-500'}`}
        >
          <Home size={20} />
          <span className="text-[9px] mt-1 font-bold">الرئيسية</span>
        </button>
        <button
          onClick={() => setActiveSection('farm')}
          className={`flex flex-col items-center p-2 rounded-2xl transition-all ${activeSection === 'farm' ? 'bg-islamic-green dark:bg-emerald-600 text-white shadow-lg' : 'text-slate-400 dark:text-slate-500'}`}
        >
          <Sprout size={20} />
          <span className="text-[9px] mt-1 font-bold">المزرعة</span>
        </button>
        <button
          onClick={() => setActiveSection('knowledge')}
          className={`flex flex-col items-center p-2 rounded-2xl transition-all ${activeSection === 'knowledge' ? 'bg-islamic-green dark:bg-emerald-600 text-white shadow-lg' : 'text-slate-400 dark:text-slate-500'}`}
        >
          <BookOpen size={20} />
          <span className="text-[9px] mt-1 font-bold">العلم</span>
        </button>
        <button
          onClick={() => setActiveSection('ahl-allah')}
          className={`flex flex-col items-center p-2 rounded-2xl transition-all ${activeSection === 'ahl-allah' ? 'bg-islamic-green dark:bg-emerald-600 text-white shadow-lg' : 'text-slate-400 dark:text-slate-500'}`}
        >
          <Users size={20} />
          <span className="text-[9px] mt-1 font-bold">أهل الله</span>
        </button>
        <button
          onClick={() => setActiveSection('misbaha')}
          className={`flex flex-col items-center p-2 rounded-2xl transition-all ${activeSection === 'misbaha' ? 'bg-islamic-green dark:bg-emerald-600 text-white shadow-lg' : 'text-slate-400 dark:text-slate-500'}`}
        >
          <RotateCcw size={20} />
          <span className="text-[9px] mt-1 font-bold">المسبحة</span>
        </button>
      </nav>

      <AnimatePresence>
        {notificationDhikr && (
          <motion.div
            initial={{ y: 100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 100, opacity: 0 }}
            onClick={() => setNotificationDhikr(null)}
            className="fixed bottom-28 left-6 right-6 bg-emerald-600 text-white p-4 rounded-2xl shadow-2xl z-[60] flex items-center justify-between cursor-pointer"
          >
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                <Star size={20} />
              </div>
              <div>
                <p className="text-[10px] opacity-80">ذكر الساعة</p>
                <p className="font-bold">{notificationDhikr}</p>
              </div>
            </div>
            <Check size={20} />
          </motion.div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {toast && (
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 50 }}
            className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[200] px-6 py-3 bg-slate-900/90 dark:bg-emerald-600/90 backdrop-blur-md text-white rounded-full shadow-2xl border border-white/10 flex items-center gap-3 min-w-[200px] justify-center"
          >
            <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />
            <span className="text-sm font-bold">{toast.message}</span>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
